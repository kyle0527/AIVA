#!/usr/bin/env python3
"""
æ¸¬è©¦æ¼æ´åˆ©ç”¨åŸ·è¡ŒåŠŸèƒ½
é‡å° Juice Shop é¶å ´é€²è¡Œå¯¦éš›æ¸¬è©¦
"""

import asyncio
import sys
import os

# æ·»åŠ è·¯å¾‘
sys.path.append(os.path.join(os.path.dirname(__file__), 'services/core'))
sys.path.append(os.path.join(os.path.dirname(__file__), 'services/aiva_common'))

async def test_exploit_manager():
    """æ¸¬è©¦æ¼æ´åˆ©ç”¨ç®¡ç†å™¨åŠŸèƒ½"""
    try:
        from aiva_core.attack.exploit_manager import ExploitManager
        from aiva_common.enums.security import ExploitType
        
        print("ğŸš€ åˆå§‹åŒ–æ¼æ´åˆ©ç”¨ç®¡ç†å™¨...")
        manager = ExploitManager()
        
        # è¨»å†Šæ¸¬è©¦æ¼æ´åˆ©ç”¨
        test_exploits = [
            {
                'id': 'juice_shop_idor_test',
                'name': 'Juice Shop IDOR æ¸¬è©¦',
                'type': ExploitType.IDOR,
                'payloads': ['user_id_1', 'user_id_2'],
                'description': 'é‡å° Juice Shop çš„ IDOR æ¼æ´æ¸¬è©¦'
            },
            {
                'id': 'juice_shop_sql_injection_test',
                'name': 'Juice Shop SQL æ³¨å…¥æ¸¬è©¦',
                'type': ExploitType.SQL_INJECTION,
                'payloads': ["' OR 1=1--", "admin'--"],
                'description': 'é‡å° Juice Shop çš„ SQL æ³¨å…¥æ¸¬è©¦'
            },
            {
                'id': 'juice_shop_xss_test',
                'name': 'Juice Shop XSS æ¸¬è©¦',
                'type': ExploitType.XSS,
                'payloads': ["<script>alert('XSS')</script>", "<img src=x onerror=alert(1)>"],
                'description': 'é‡å° Juice Shop çš„ XSS æ¼æ´æ¸¬è©¦'
            }
        ]
        
        for exploit in test_exploits:
            manager.register_exploit(exploit)
            print(f"âœ… è¨»å†Šæ¼æ´åˆ©ç”¨: {exploit['name']}")
        
        print(f"\nğŸ“Š å·²è¨»å†Šæ¼æ´åˆ©ç”¨æ•¸é‡: {len(manager.exploit_registry)}")
        
        # æ¸¬è©¦ç›®æ¨™ (Juice Shop å®¹å™¨)
        target = {'url': 'http://localhost:3000'}
        print(f"\nğŸ¯ æ¸¬è©¦ç›®æ¨™: {target['url']}")
        
        # åŸ·è¡Œå„ç¨®æ¼æ´åˆ©ç”¨æ¸¬è©¦
        results = []
        
        for exploit_id in ['juice_shop_idor_test', 'juice_shop_sql_injection_test', 'juice_shop_xss_test']:
            print(f"\nğŸ” åŸ·è¡Œæ¼æ´åˆ©ç”¨: {exploit_id}")
            
            try:
                result = await manager.execute_exploit(exploit_id, target)
                results.append(result)
                
                print(f"  - åŸ·è¡Œç‹€æ…‹: {'âœ… æˆåŠŸ' if result.get('success') else 'âŒ å¤±æ•—'}")
                print(f"  - æ¼æ´é¡å‹: {result.get('exploit_type', 'unknown')}")
                print(f"  - æ¸¬è©¦è¼‰è·: {result.get('payloads_tested', 0)} å€‹")
                print(f"  - ç™¼ç¾æ¼æ´: {'âš ï¸ æ˜¯' if result.get('vulnerable') else 'âœ… å¦'}")
                print(f"  - ç™¼ç¾å•é¡Œ: {len(result.get('findings', []))} å€‹")
                
                # é¡¯ç¤ºç™¼ç¾çš„å•é¡Œè©³æƒ…
                findings = result.get('findings', [])
                if findings:
                    print("  - å•é¡Œè©³æƒ…:")
                    for i, finding in enumerate(findings[:3], 1):  # æœ€å¤šé¡¯ç¤ºå‰3å€‹
                        severity = finding.get('severity', 'UNKNOWN')
                        vuln_type = finding.get('vulnerability', 'Unknown')
                        endpoint = finding.get('endpoint', 'N/A')
                        print(f"    {i}. [{severity}] {vuln_type} @ {endpoint}")
                
            except Exception as e:
                print(f"  - âŒ æ¸¬è©¦å¤±æ•—: {str(e)}")
                results.append({'success': False, 'error': str(e)})
        
        # çµ±è¨ˆçµæœ
        print(f"\nğŸ“ˆ æ¸¬è©¦ç¸½çµ:")
        successful_tests = sum(1 for r in results if r.get('success'))
        total_vulnerabilities = sum(len(r.get('findings', [])) for r in results)
        total_payloads = sum(r.get('payloads_tested', 0) for r in results)
        
        print(f"  - æˆåŠŸåŸ·è¡Œæ¸¬è©¦: {successful_tests}/{len(results)}")
        print(f"  - ç™¼ç¾æ¼æ´ç¸½æ•¸: {total_vulnerabilities}")
        print(f"  - æ¸¬è©¦è¼‰è·ç¸½æ•¸: {total_payloads}")
        
        # ç²å–çµ±è¨ˆè³‡è¨Š
        stats = manager.get_statistics()
        print(f"\nğŸ“Š ç®¡ç†å™¨çµ±è¨ˆ:")
        print(f"  - è¨»å†Šæ¼æ´åˆ©ç”¨: {stats.get('total_exploits', 0)}")
        print(f"  - ç¸½åŸ·è¡Œæ¬¡æ•¸: {stats.get('total_executions', 0)}")
        
        return results
        
    except ImportError as e:
        print(f"âŒ å°å…¥éŒ¯èª¤: {e}")
        print("è«‹ç¢ºä¿æ‰€æœ‰å¿…è¦çš„æ¨¡çµ„éƒ½å·²å®‰è£")
        return None
    except Exception as e:
        print(f"âŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤: {e}")
        import traceback
        traceback.print_exc()
        return None

async def test_attack_executor():
    """æ¸¬è©¦æ”»æ“ŠåŸ·è¡Œå™¨åŠŸèƒ½"""
    try:
        from aiva_core.attack.attack_executor import AttackExecutor
        
        print("\nğŸ”§ æ¸¬è©¦æ”»æ“ŠåŸ·è¡Œå™¨...")
        executor = AttackExecutor()
        
        # æ¨¡æ“¬æ”»æ“Šæ­¥é©Ÿ
        test_step = {
            'type': 'idor',
            'payload': {
                'payloads': ['test1', 'test2']
            },
            'target': {'url': 'http://localhost:3000'}
        }
        
        target = {'url': 'http://localhost:3000'}
        
        print("ğŸ¯ åŸ·è¡Œæ”»æ“Šæ­¥é©Ÿ...")
        result = await executor._real_execute_step(test_step, target)
        
        print(f"  - åŸ·è¡Œç‹€æ…‹: {'âœ… æˆåŠŸ' if result.get('success') else 'âŒ å¤±æ•—'}")
        print(f"  - è¨Šæ¯: {result.get('message', 'N/A')}")
        print(f"  - ç™¼ç¾å•é¡Œ: {len(result.get('findings', []))} å€‹")
        print(f"  - æ¸¬è©¦è¼‰è·: {result.get('payloads_tested', 0)} å€‹")
        
        return result
        
    except Exception as e:
        print(f"âŒ æ”»æ“ŠåŸ·è¡Œå™¨æ¸¬è©¦å¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
        return None

async def main():
    """ä¸»æ¸¬è©¦å‡½æ•¸"""
    print("ğŸ§ª AIVA æ¼æ´åˆ©ç”¨åŸ·è¡ŒåŠŸèƒ½æ¸¬è©¦")
    print("=" * 50)
    
    # æª¢æŸ¥ Juice Shop æ˜¯å¦é‹è¡Œ
    try:
        import aiohttp
        
        async with aiohttp.ClientSession() as session:
            async with session.get('http://localhost:3000', timeout=aiohttp.ClientTimeout(total=5)) as response:
                if response.status == 200:
                    print("âœ… Juice Shop é¶å ´é€£æ¥æ­£å¸¸")
                else:
                    print(f"âš ï¸ Juice Shop å›æ‡‰ç•°å¸¸ (HTTP {response.status})")
    except ImportError:
        print("âš ï¸ aiohttp æœªå®‰è£ï¼Œç„¡æ³•é€²è¡Œå¯¦éš›ç¶²è·¯æ¸¬è©¦")
    except Exception as e:
        print(f"âš ï¸ ç„¡æ³•é€£æ¥åˆ° Juice Shop: {e}")
        print("   è«‹ç¢ºä¿ Docker å®¹å™¨æ­£åœ¨é‹è¡Œåœ¨ localhost:3000")
    
    print("\n" + "=" * 50)
    
    # æ¸¬è©¦æ¼æ´åˆ©ç”¨ç®¡ç†å™¨
    exploit_results = await test_exploit_manager()
    
    # æ¸¬è©¦æ”»æ“ŠåŸ·è¡Œå™¨
    executor_result = await test_attack_executor()
    
    print("\n" + "=" * 50)
    print("ğŸ æ¸¬è©¦å®Œæˆï¼")
    
    if exploit_results and any(r.get('success') for r in exploit_results):
        print("âœ… æ¼æ´åˆ©ç”¨åŸ·è¡ŒåŠŸèƒ½å·²æˆåŠŸå¯¦ç¾")
    else:
        print("âŒ æ¼æ´åˆ©ç”¨åŸ·è¡ŒåŠŸèƒ½éœ€è¦é€²ä¸€æ­¥èª¿è©¦")

if __name__ == "__main__":
    asyncio.run(main())