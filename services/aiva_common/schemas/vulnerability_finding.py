"""
AIVA 統一漏洞發現模型 - 單一來源定義
遵循 AIVA Common 開發規範和單一來源原則 (SOT)
"""

from dataclasses import dataclass
from datetime import datetime
from typing import Any, Dict, List, Optional
from pydantic import BaseModel, Field

from aiva_common.enums import Confidence, Severity, VulnerabilityType
from aiva_common.schemas.security.findings import Target, FindingEvidence


@dataclass
class VulnerabilityCategory:
    """漏洞分類"""
    name: str
    description: str
    cwe_id: Optional[str] = None


@dataclass 
class VulnerabilitySeverity:
    """漏洞嚴重程度 (向後相容)"""
    level: str
    score: float
    description: str


class UnifiedVulnerabilityFinding(BaseModel):
    """統一漏洞發現模型 - AIVA v5.0 標準定義
    
    整合了來自不同模組的漏洞發現需求：
    - 掃描模組 (discovery_schemas.py)
    - Bug Bounty 報告 (bug_bounty_reporting.py)  
    - API 測試 (api_standards.py)
    
    遵循原則：
    - 單一來源原則 (SOT)
    - 向後相容性
    - 完整性和擴展性
    """
    
    # 核心標識
    finding_id: str = Field(description="發現唯一標識符", pattern=r"^finding_[a-zA-Z0-9_]+$")
    scan_id: Optional[str] = Field(default=None, description="關聯的掃描ID")
    test_id: Optional[str] = Field(default=None, description="關聯測試ID")
    
    # 漏洞基本信息
    title: str = Field(description="漏洞標題")
    name: Optional[str] = Field(default=None, description="漏洞名稱 (別名)")
    description: str = Field(description="漏洞詳細描述")
    vulnerability_type: VulnerabilityType = Field(description="漏洞類型")
    
    # 嚴重程度和置信度
    severity: Severity = Field(description="嚴重程度")
    confidence: Confidence = Field(description="置信度")
    confidence_score: Optional[int] = Field(default=None, ge=0, le=100, description="置信度分數")
    
    # 目標和位置信息
    target: Target = Field(description="漏洞目標")
    target_url: Optional[str] = Field(default=None, description="目標URL (向後相容)")
    endpoint: Optional[str] = Field(default=None, description="API端點 (向後相容)")
    
    # 漏洞詳情
    impact: str = Field(description="影響描述")
    reproduction_steps: List[str] = Field(default_factory=list, description="復現步驟")
    evidence: List[FindingEvidence] = Field(default_factory=list, description="漏洞證據")
    
    # 分類和標記
    category: Optional[VulnerabilityCategory] = Field(default=None, description="漏洞分類")
    cwe_id: Optional[str] = Field(default=None, description="CWE標識")
    owasp_category: Optional[str] = Field(default=None, description="OWASP分類")
    
    # 修復建議
    remediation: Optional[str] = Field(default=None, description="修復建議")
    effort_estimate: Optional[str] = Field(default=None, description="修復工作量估計")
    
    # 時間戳
    discovered_at: datetime = Field(default_factory=datetime.now, description="發現時間")
    created_at: datetime = Field(default_factory=datetime.now, description="記錄創建時間")
    updated_at: Optional[datetime] = Field(default=None, description="最後更新時間")
    
    # 擴展字段
    metadata: Dict[str, Any] = Field(default_factory=dict, description="擴展元數據")


# 向後相容別名
VulnerabilityFinding = UnifiedVulnerabilityFinding
APIVulnerabilityFinding = UnifiedVulnerabilityFinding

__all__ = [
    "UnifiedVulnerabilityFinding",
    "VulnerabilityFinding", 
    "APIVulnerabilityFinding",
    "VulnerabilityCategory",
    "VulnerabilitySeverity"
]