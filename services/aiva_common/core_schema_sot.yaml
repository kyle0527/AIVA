# AIVA Core Schema - Single Source of Truth (SOT)
# 版本: 1.0.0
# 此文件是所有跨語言Schema的唯一事實來源
# 支援自動生成: Python (Pydantic v2) | Go (structs + JSON tags) | Rust (Serde)

version: "1.0.0"
metadata:
  description: "AIVA跨語言Schema統一定義"
  generated_note: "此檔案由core_schema_sot.yaml自動生成，請勿手動修改"
  last_updated: "2025-10-23T00:00:00Z"

# ==================== 基礎類型定義 ====================
base_types:
  MessageHeader:
    description: "統一訊息標頭 - 所有跨服務通訊的基礎"
    fields:
      message_id:
        type: "str"
        required: true
        description: "唯一訊息識別碼"
        validation:
          pattern: "^[a-zA-Z0-9_-]+$"
          max_length: 128
      trace_id:
        type: "str"
        required: true
        description: "分散式追蹤識別碼"
        validation:
          pattern: "^[a-fA-F0-9-]+$"
      correlation_id:
        type: "Optional[str]"
        required: false
        description: "關聯識別碼 - 用於請求-響應配對"
      source_module:
        type: "str"
        required: true
        description: "來源模組名稱"
        validation:
          enum: ["ai_engine", "attack_engine", "scan_engine", "integration_services", "feature_detection"]
      timestamp:
        type: "datetime"
        required: true
        description: "訊息時間戳"
      version:
        type: "str"
        required: true
        default: "1.0"
        description: "Schema版本號"

  Target:
    description: "掃描/攻擊目標定義"
    fields:
      url:
        type: "str"
        required: true
        description: "目標URL"
        validation:
          format: "url"
      parameter:
        type: "Optional[str]"
        required: false
        description: "目標參數名稱"
      method:
        type: "Optional[str]"
        required: false
        default: "GET"
        description: "HTTP方法"
        validation:
          enum: ["GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS"]
      headers:
        type: "Dict[str, str]"
        required: false
        default: {}
        description: "HTTP標頭"
      params:
        type: "Dict[str, Any]"
        required: false
        default: {}
        description: "HTTP參數"
      body:
        type: "Optional[str]"
        required: false
        description: "HTTP請求體"

  Vulnerability:
    description: "漏洞資訊定義"
    fields:
      name:
        type: "str"
        required: true
        description: "漏洞名稱"
        validation:
          max_length: 255
      cwe:
        type: "Optional[str]"
        required: false
        description: "CWE編號"
        validation:
          pattern: "^CWE-[0-9]+$"
      severity:
        type: "str"
        required: true
        description: "嚴重程度"
        validation:
          enum: ["critical", "high", "medium", "low", "info"]
      confidence:
        type: "str"
        required: true
        description: "信心度"
        validation:
          enum: ["confirmed", "firm", "tentative"]
      description:
        type: "Optional[str]"
        required: false
        description: "漏洞描述"

# ==================== 訊息通訊Schema ====================
messaging:
  AivaMessage:
    description: "AIVA統一訊息格式 - 所有跨服務通訊的標準信封"
    fields:
      header:
        type: "MessageHeader"
        required: true
        description: "訊息標頭"
      topic:
        type: "str"
        required: true
        description: "訊息主題"
        validation:
          enum: ["tasks", "findings", "events", "commands", "responses"]
      schema_version:
        type: "str"
        required: true
        default: "1.0"
        description: "Schema版本"
      payload:
        type: "Dict[str, Any]"
        required: true
        description: "訊息載荷"

  AIVARequest:
    description: "統一請求格式 - 模組間請求通訊"
    fields:
      request_id:
        type: "str"
        required: true
        description: "請求識別碼"
      source_module:
        type: "str"
        required: true
        description: "來源模組"
      target_module:
        type: "str"
        required: true
        description: "目標模組"
      request_type:
        type: "str"
        required: true
        description: "請求類型"
      payload:
        type: "Dict[str, Any]"
        required: true
        description: "請求載荷"
      trace_id:
        type: "Optional[str]"
        required: false
        description: "追蹤識別碼"
      timeout_seconds:
        type: "int"
        required: true
        default: 30
        description: "逾時秒數"
        validation:
          minimum: 1
          maximum: 300
      metadata:
        type: "Dict[str, Any]"
        required: false
        default: {}
        description: "中繼資料"
      timestamp:
        type: "str"
        required: true
        description: "時間戳"

  AIVAResponse:
    description: "統一響應格式 - 模組間響應通訊"
    fields:
      request_id:
        type: "str"
        required: true
        description: "對應的請求識別碼"
      response_type:
        type: "str"
        required: true
        description: "響應類型"
      success:
        type: "bool"
        required: true
        description: "執行是否成功"
      payload:
        type: "Optional[Dict[str, Any]]"
        required: false
        description: "響應載荷"
      error_code:
        type: "Optional[str]"
        required: false
        description: "錯誤代碼"
      error_message:
        type: "Optional[str]"
        required: false
        description: "錯誤訊息"
      metadata:
        type: "Dict[str, Any]"
        required: false
        default: {}
        description: "中繼資料"
      timestamp:
        type: "str"
        required: true
        description: "時間戳"

# ==================== 任務管理Schema ====================
tasks:
  FunctionTaskPayload:
    description: "功能任務載荷 - 掃描任務的標準格式"
    fields:
      task_id:
        type: "str"
        required: true
        description: "任務識別碼"
      scan_id:
        type: "str"
        required: true
        description: "掃描識別碼"
      priority:
        type: "int"
        required: true
        description: "任務優先級"
        validation:
          minimum: 0
          maximum: 10
      target:
        type: "FunctionTaskTarget"
        required: true
        description: "掃描目標"
      context:
        type: "FunctionTaskContext"
        required: true
        description: "任務上下文"
      strategy:
        type: "str"
        required: true
        description: "掃描策略"
        validation:
          enum: ["fast", "deep", "aggressive", "stealth"]
      custom_payloads:
        type: "List[str]"
        required: false
        default: []
        description: "自訂載荷"
      test_config:
        type: "FunctionTaskTestConfig"
        required: true
        description: "測試配置"

  FunctionTaskTarget:
    description: "功能任務目標"
    extends: "Target"
    additional_fields:
      parameter_location:
        type: "str"
        required: true
        description: "參數位置"
        validation:
          enum: ["url", "query", "form", "json", "header", "cookie"]
      cookies:
        type: "Dict[str, str]"
        required: false
        default: {}
        description: "Cookie資料"
      form_data:
        type: "Dict[str, Any]"
        required: false
        default: {}
        description: "表單資料"
      json_data:
        type: "Optional[Dict[str, Any]]"
        required: false
        description: "JSON資料"

  FunctionTaskContext:
    description: "功能任務上下文"
    fields:
      db_type_hint:
        type: "Optional[str]"
        required: false
        description: "資料庫類型提示"
        validation:
          enum: ["mysql", "postgresql", "mssql", "oracle", "sqlite", "mongodb"]
      waf_detected:
        type: "bool"
        required: true
        default: false
        description: "是否檢測到WAF"
      related_findings:
        type: "List[str]"
        required: false
        default: []
        description: "相關發現"

  FunctionTaskTestConfig:
    description: "功能任務測試配置"
    fields:
      payloads:
        type: "List[str]"
        required: true
        description: "標準載荷列表"
      custom_payloads:
        type: "List[str]"
        required: false
        default: []
        description: "自訂載荷列表"
      blind_xss:
        type: "bool"
        required: true
        default: false
        description: "是否進行Blind XSS測試"
      dom_testing:
        type: "bool"
        required: true
        default: false
        description: "是否進行DOM測試"
      timeout:
        type: "Optional[float]"
        required: false
        description: "請求逾時(秒)"
        validation:
          minimum: 0.1
          maximum: 60.0

# ==================== 發現結果Schema ====================
findings:
  FindingPayload:
    description: "漏洞發現載荷 - 掃描結果的標準格式"
    fields:
      finding_id:
        type: "str"
        required: true
        description: "發現識別碼"
      task_id:
        type: "str"
        required: true
        description: "任務識別碼"
      scan_id:
        type: "str"
        required: true
        description: "掃描識別碼"
      status:
        type: "str"
        required: true
        description: "發現狀態"
        validation:
          enum: ["new", "confirmed", "false_positive", "fixed", "ignored"]
      vulnerability:
        type: "Vulnerability"
        required: true
        description: "漏洞資訊"
      target:
        type: "Target"
        required: true
        description: "目標資訊"
      strategy:
        type: "Optional[str]"
        required: false
        description: "使用的策略"
      evidence:
        type: "Optional[FindingEvidence]"
        required: false
        description: "證據資料"
      impact:
        type: "Optional[FindingImpact]"
        required: false
        description: "影響評估"
      recommendation:
        type: "Optional[FindingRecommendation]"
        required: false
        description: "修復建議"
      metadata:
        type: "Dict[str, Any]"
        required: false
        default: {}
        description: "中繼資料"
      created_at:
        type: "datetime"
        required: true
        description: "建立時間"
      updated_at:
        type: "datetime"
        required: true
        description: "更新時間"

  FindingEvidence:
    description: "漏洞證據"
    fields:
      payload:
        type: "Optional[str]"
        required: false
        description: "攻擊載荷"
      response_time_delta:
        type: "Optional[float]"
        required: false
        description: "響應時間差異"
      db_version:
        type: "Optional[str]"
        required: false
        description: "資料庫版本"
      request:
        type: "Optional[str]"
        required: false
        description: "HTTP請求"
      response:
        type: "Optional[str]"
        required: false
        description: "HTTP響應"
      proof:
        type: "Optional[str]"
        required: false
        description: "證明資料"

  FindingImpact:
    description: "漏洞影響評估"
    fields:
      description:
        type: "Optional[str]"
        required: false
        description: "影響描述"
      business_impact:
        type: "Optional[str]"
        required: false
        description: "業務影響"
      technical_impact:
        type: "Optional[str]"
        required: false
        description: "技術影響"
      affected_users:
        type: "Optional[int]"
        required: false
        description: "受影響用戶數"
        validation:
          minimum: 0
      estimated_cost:
        type: "Optional[float]"
        required: false
        description: "估計成本"
        validation:
          minimum: 0.0

  FindingRecommendation:
    description: "漏洞修復建議"
    fields:
      fix:
        type: "Optional[str]"
        required: false
        description: "修復方法"
      priority:
        type: "Optional[str]"
        required: false
        description: "修復優先級"
        validation:
          enum: ["critical", "high", "medium", "low"]
      remediation_steps:
        type: "List[str]"
        required: false
        default: []
        description: "修復步驟"
      references:
        type: "List[str]"
        required: false
        default: []
        description: "參考資料"

# ==================== 語言特定生成配置 ====================
generation_config:
  python:
    target_dir: "services/aiva_common/schemas/generated"
    base_imports:
      - "from __future__ import annotations"
      - "from typing import Any, Dict, List, Optional"
      - "from datetime import datetime"
      - "from pydantic import BaseModel, Field"
    field_mapping:
      "str": "str"
      "int": "int"  
      "float": "float"
      "bool": "bool"
      "datetime": "datetime"
      "Dict[str, Any]": "Dict[str, Any]"
      "Dict[str, str]": "Dict[str, str]"
      "List[str]": "List[str]"
      "Optional[str]": "Optional[str]"
    
  go:
    target_dir: "services/features/common/go/aiva_common_go/schemas/generated"
    base_imports:
      - "package schemas"
      - "import \"time\""
    field_mapping:
      "str": "string"
      "int": "int"
      "float": "float64" 
      "bool": "bool"
      "datetime": "time.Time"
      "Dict[str, Any]": "map[string]interface{}"
      "Dict[str, str]": "map[string]string"
      "List[str]": "[]string"
      "Optional[str]": "*string"
      
  rust:
    target_dir: "services/scan/info_gatherer_rust/src/schemas/generated"
    base_imports:
      - "use serde::{Deserialize, Serialize};"
      - "use std::collections::HashMap;"
      - "use chrono::{DateTime, Utc};"
    field_mapping:
      "str": "String"
      "int": "i32"
      "float": "f64"
      "bool": "bool" 
      "datetime": "DateTime<Utc>"
      "Dict[str, Any]": "HashMap<String, serde_json::Value>"
      "Dict[str, str]": "HashMap<String, String>"
      "List[str]": "Vec<String>"
      "Optional[str]": "Option<String>"