# AIVA Go ÊéÉÊèèÂô® Makefile
# ÈáçÊßãÂæåÁöÑÁµ±‰∏ÄÊßãÂª∫ÊµÅÁ®ã

# Â∏∏ÈáèÂÆöÁæ©
BUILD_DIR := bin
GO_FLAGS := -ldflags="-s -w" -trimpath

# Ëá™ÂãïÊ™¢Ê∏¨Âπ≥Âè∞
UNAME_S := $(shell uname -s 2>/dev/null || echo "Windows")
ifeq ($(UNAME_S),Linux)
    PLATFORM := linux
    EXT := 
endif
ifeq ($(UNAME_S),Darwin)
    PLATFORM := darwin
    EXT := 
endif
ifeq ($(UNAME_S),Windows)
    PLATFORM := windows
    EXT := .exe
endif
ifndef PLATFORM
    PLATFORM := windows
    EXT := .exe
endif

# È†êË®≠ÁõÆÊ®ô
.PHONY: all
all: build

# ÊßãÂª∫ÊâÄÊúâÊéÉÊèèÂô®
.PHONY: build
build:
	@echo "üöÄ Building all Go scanners for platform: $(PLATFORM)"
	@mkdir -p $(BUILD_DIR)
	@cd cmd/ssrf-scanner && go build $(GO_FLAGS) -o ../../$(BUILD_DIR)/ssrf-scanner$(EXT) .
	@cd cmd/cspm-scanner && go build $(GO_FLAGS) -o ../../$(BUILD_DIR)/cspm-scanner$(EXT) .
	@cd cmd/sca-scanner && go build $(GO_FLAGS) -o ../../$(BUILD_DIR)/sca-scanner$(EXT) .
	@echo "‚úÖ All scanners built successfully"

# ÊßãÂª∫ÂñÆ‰∏ÄÊéÉÊèèÂô®
.PHONY: ssrf cspm sca
ssrf:
	@echo "üîç Building SSRF scanner..."
	@mkdir -p $(BUILD_DIR)
	@cd cmd/ssrf-scanner && go build $(GO_FLAGS) -o ../../$(BUILD_DIR)/ssrf-scanner$(EXT) .

cspm:
	@echo "‚òÅÔ∏è Building CSPM scanner..."
	@mkdir -p $(BUILD_DIR)
	@cd cmd/cspm-scanner && go build $(GO_FLAGS) -o ../../$(BUILD_DIR)/cspm-scanner$(EXT) .

sca:
	@echo "üì¶ Building SCA scanner..."
	@mkdir -p $(BUILD_DIR)
	@cd cmd/sca-scanner && go build $(GO_FLAGS) -o ../../$(BUILD_DIR)/sca-scanner$(EXT) .

# Âø´ÈÄüÈáçÂª∫
.PHONY: rebuild
rebuild: clean build

# Ê∏ÖÁêÜÊßãÂª∫Ê™îÊ°à
.PHONY: clean
clean:
	@echo "üßπ Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR)/*$(EXT) 2>/dev/null || true
	@echo "‚úÖ Clean completed"

# Ê™¢Êü•ÂâçÁΩÆÊ¢ù‰ª∂
.PHONY: check
check:
	@echo "üîç Checking prerequisites..."
	@command -v go >/dev/null 2>&1 || { echo "‚ùå Go is not installed"; exit 1; }
	@echo "‚úÖ Go version: $$(go version)"

# ÈñãÁôºÁí∞Â¢ÉË®≠ÁΩÆ
.PHONY: setup
setup: check
	@echo "‚ö° Setting up development environment..."
	@go work sync
	@echo "‚úÖ Development environment ready"

# È°ØÁ§∫ÊßãÂª∫ÁãÄÊÖã
.PHONY: status
status:
	@echo "üìä Build Status Report"
	@echo "======================"
	@echo "Platform: $(PLATFORM)"
	@echo "Extension: $(EXT)"
	@echo ""
	@ls -lh $(BUILD_DIR)/*$(EXT) 2>/dev/null || echo "No binaries found"

# Âπ´Âä©Ë≥áË®ä
.PHONY: help
help:
	@echo "AIVA Go Scanner Build System (Refactored)"
	@echo "=========================================="
	@echo ""
	@echo "Available targets:"
	@echo "  build        - Build all scanners (default)"
	@echo "  ssrf         - Build SSRF scanner only"
	@echo "  cspm         - Build CSPM scanner only"
	@echo "  sca          - Build SCA scanner only"
	@echo "  rebuild      - Clean and rebuild all"
	@echo "  clean        - Remove all build artifacts"
	@echo "  check        - Check prerequisites"
	@echo "  setup        - Set up development environment"
	@echo "  status       - Show build status"
	@echo ""
	@echo "Usage examples:"
	@echo "  make build    # Build all scanners"
	@echo "  make ssrf     # Build only SSRF scanner"
	@echo "  make rebuild  # Clean and rebuild"

# Ë∑®Âπ≥Âè∞ÊßãÂª∫
.PHONY: build-windows build-linux build-darwin build-arm64
build-windows:
	@echo "ü™ü Building for Windows..."
	@$(PYTHON_BUILD) --scanner all --platform windows

build-linux:
	@echo "üêß Building for Linux..."
	@$(PYTHON_BUILD) --scanner all --platform linux

build-darwin:
	@echo "üçé Building for macOS..."
	@$(PYTHON_BUILD) --scanner all --platform darwin

build-arm64:
	@echo "üí™ Building for ARM64..."
	@$(PYTHON_BUILD) --scanner all --platform arm64

# Ê∏ÖÁêÜÊßãÂª∫Ê™îÊ°à
.PHONY: clean
clean:
	@echo "üßπ Cleaning build artifacts..."
	@$(PYTHON_BUILD) --clean --check
	@for dir in $(SCANNER_DIRS); do \
		if [ -d $$dir ]; then \
			echo "Cleaning $$dir..."; \
			find $$dir -name "worker*" -type f -delete 2>/dev/null || true; \
		fi; \
	done
	@if [ -d $(BUILD_DIR) ]; then rm -rf $(BUILD_DIR); fi
	@echo "‚úÖ Clean completed"

# Ê™¢Êü•ÂâçÁΩÆÊ¢ù‰ª∂
.PHONY: check
check:
	@echo "üîç Checking prerequisites..."
	@$(PYTHON_BUILD) --check

# ÈñãÁôºÁí∞Â¢ÉË®≠ÁΩÆ
.PHONY: setup
setup: check
	@echo "‚ö° Setting up development environment..."
	@if ! command -v go >/dev/null 2>&1; then \
		echo "‚ùå Go is not installed. Please install Go 1.21+"; \
		exit 1; \
	fi
	@echo "üì¶ Downloading Go dependencies..."
	@go mod download
	@go mod tidy
	@echo "‚úÖ Development environment ready"

# Ê∏¨Ë©¶ÊâÄÊúâÊéÉÊèèÂô®
.PHONY: test
test: build
	@echo "üß™ Testing all scanners..."
	@for dir in $(SCANNER_DIRS); do \
		if [ -f $$dir/worker$(EXT) ]; then \
			echo "Testing $$dir..."; \
			./$$dir/worker$(EXT) --version || echo "‚ö†Ô∏è  $$dir test failed"; \
		else \
			echo "‚ùå $$dir/worker$(EXT) not found"; \
		fi; \
	done

# ÂÆâË£ùÊéÉÊèèÂô®Âà∞Á≥ªÁµ±
.PHONY: install
install: build
	@echo "üì¶ Installing scanners..."
	@mkdir -p /usr/local/bin/aiva-scanners 2>/dev/null || mkdir -p ~/bin/aiva-scanners
	@for dir in $(SCANNER_DIRS); do \
		if [ -f $$dir/worker$(EXT) ]; then \
			cp $$dir/worker$(EXT) /usr/local/bin/aiva-scanners/$$dir$(EXT) 2>/dev/null || \
			cp $$dir/worker$(EXT) ~/bin/aiva-scanners/$$dir$(EXT) || \
			echo "‚ö†Ô∏è  Could not install $$dir"; \
		fi; \
	done
	@echo "‚úÖ Installation completed"

# È°ØÁ§∫ÊßãÂª∫ÁãÄÊÖã
.PHONY: status
status:
	@echo "üìä Build Status Report"
	@echo "======================"
	@echo "Platform: $(PLATFORM)"
	@echo "Extension: $(EXT)"
	@echo ""
	@for dir in $(SCANNER_DIRS); do \
		printf "%-15s: " $$dir; \
		if [ -f $$dir/worker$(EXT) ]; then \
			size=$$(du -h $$dir/worker$(EXT) 2>/dev/null | cut -f1 || echo "?"); \
			echo "‚úÖ Built ($$size)"; \
		else \
			echo "‚ùå Missing"; \
		fi; \
	done
	@echo ""
	@if [ -d $(BUILD_DIR) ]; then \
		echo "Build directory: $(BUILD_DIR)/ (exists)"; \
	else \
		echo "Build directory: $(BUILD_DIR)/ (missing)"; \
	fi

# Âø´ÈÄüÈáçÂª∫
.PHONY: rebuild
rebuild: clean build

# Âπ´Âä©Ë≥áË®ä
.PHONY: help
help:
	@echo "AIVA Go Scanner Build System"
	@echo "============================"
	@echo ""
	@echo "Available targets:"
	@echo "  build        - Build all scanners (default)"
	@echo "  ssrf         - Build SSRF scanner only"
	@echo "  cspm         - Build CSPM scanner only"
	@echo "  sca          - Build SCA scanner only"
	@echo ""
	@echo "Cross-platform builds:"
	@echo "  build-windows - Build for Windows"
	@echo "  build-linux   - Build for Linux"
	@echo "  build-darwin  - Build for macOS"
	@echo "  build-arm64   - Build for ARM64"
	@echo ""
	@echo "Maintenance:"
	@echo "  clean        - Remove all build artifacts"
	@echo "  check        - Check prerequisites"
	@echo "  setup        - Set up development environment"
	@echo "  test         - Test all built scanners"
	@echo "  install      - Install scanners to system"
	@echo "  status       - Show build status"
	@echo "  rebuild      - Clean and build"
	@echo ""
	@echo "Usage examples:"
	@echo "  make build           # Build all scanners"
	@echo "  make ssrf            # Build only SSRF scanner"
	@echo "  make build-windows   # Cross-compile for Windows"
	@echo "  make clean build     # Clean rebuild"