#!/usr/bin/env python3
"""
AIVA ç¶œåˆå¯¦æˆ°æ»²é€æ¸¬è©¦åŸ·è¡Œå™¨

ä¿®å¾©æ‰€æœ‰ä¾è³´å•é¡Œå¾Œçš„å®Œæ•´æ»²é€æ¸¬è©¦å·¥å…·
éµå¾ª aiva_common è¦ç¯„ï¼Œä½¿ç”¨æ¨™æº–åŒ–çš„ç·¨ç¢¼å’Œå°å…¥
"""

import asyncio
import sys
import time
from pathlib import Path
from typing import List, Dict, Any

# è¨­ç½®è·¯å¾‘
PROJECT_ROOT = Path(__file__).parent
sys.path.insert(0, str(PROJECT_ROOT))
sys.path.insert(0, str(PROJECT_ROOT / "services"))

print("[OK] AIVA ç¶œåˆå¯¦æˆ°æ»²é€æ¸¬è©¦åŸ·è¡Œå™¨ v2.0")
print("=" * 50)

class ComprehensivePentestRunner:
    """
    ç¶œåˆæ»²é€æ¸¬è©¦åŸ·è¡Œå™¨
    
    ä¿®å¾©æ‰€æœ‰ç·¨ç¢¼å’Œä¾è³´å•é¡Œå¾Œçš„å®Œæ•´ç‰ˆæœ¬
    """
    
    def __init__(self):
        self.test_targets = [
            "https://httpbin.org",
            "https://jsonplaceholder.typicode.com"
        ]
        self.results = {
            "connectivity": [],
            "sqli_test": [],
            "xss_test": [],
            "ai_dialogue": [],
            "system_validation": []
        }
    
    async def test_connectivity(self):
        """æ¸¬è©¦ç›®æ¨™é€£é€šæ€§"""
        print("\n[STEP 1] æ¸¬è©¦ç›®æ¨™é€£é€šæ€§...")
        print("-" * 30)
        
        try:
            import aiohttp
            
            async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=10)) as session:
                for target in self.test_targets:
                    try:
                        async with session.get(target) as response:
                            status = response.status
                            self.results["connectivity"].append({
                                "target": target,
                                "status": status,
                                "success": status == 200
                            })
                            
                            if status == 200:
                                print(f"[OK] {target} - é€£é€šæ€§æ¸¬è©¦æˆåŠŸ (ç‹€æ…‹ç¢¼: {status})")
                            else:
                                print(f"[WARN] {target} - ç‹€æ…‹ç¢¼: {status}")
                    
                    except Exception as e:
                        print(f"[FAIL] {target} - é€£æ¥å¤±æ•—: {e}")
                        self.results["connectivity"].append({
                            "target": target,
                            "status": None,
                            "success": False,
                            "error": str(e)
                        })
        
        except ImportError:
            print("[WARN] aiohttp æœªå®‰è£ï¼Œè·³éé€£é€šæ€§æ¸¬è©¦")
            return False
        
        return len([r for r in self.results["connectivity"] if r["success"]]) > 0
    
    def test_sqli_scanner(self):
        """æ¸¬è©¦ SQLi æƒæå™¨"""
        print("\n[STEP 2] æ¸¬è©¦ SQL æ³¨å…¥æƒæå™¨...")
        print("-" * 35)
        
        try:
            # æ¸¬è©¦ç›´æ¥å°å…¥ SQLi scanner çµ„ä»¶
            from services.features.function_sqli.payload_generator import SqliPayloadGenerator
            from services.features.function_sqli.error_detector import ErrorBasedDetector
            
            print("[OK] SQLi æƒæå™¨çµ„ä»¶å°å…¥æˆåŠŸ")
            
            # å‰µå»ºçµ„ä»¶å¯¦ä¾‹
            payload_gen = SqliPayloadGenerator()
            error_detector = ErrorBasedDetector()
            
            print("[OK] SQLi çµ„ä»¶åˆå§‹åŒ–æˆåŠŸ")
            
            # ç”Ÿæˆæ¸¬è©¦ payload
            test_payloads = payload_gen.generate_error_payloads()
            print(f"[OK] ç”Ÿæˆäº† {len(test_payloads)} å€‹ SQLi éŒ¯èª¤æª¢æ¸¬ payloads")
            
            # é¡¯ç¤ºå‰å¹¾å€‹ payload
            print("å‰5å€‹ SQLi payloads:")
            for i, payload in enumerate(test_payloads[:5]):
                print(f"  {i+1}. {payload}")
            
            # æ¸¬è©¦éŒ¯èª¤æª¢æ¸¬
            test_responses = [
                "You have an error in your SQL syntax",
                "ORA-00942: table or view does not exist",
                "Normal response without errors"
            ]
            
            detection_count = 0
            for response in test_responses:
                if error_detector.has_error_indicators(response):
                    detection_count += 1
                    print(f"[OK] éŒ¯èª¤æª¢æ¸¬æˆåŠŸ: '{response[:50]}...'")
            
            print(f"[OK] SQLi éŒ¯èª¤æª¢æ¸¬å™¨å·¥ä½œæ­£å¸¸ ({detection_count}/3 å€‹æ¸¬è©¦éŸ¿æ‡‰)")
            
            self.results["sqli_test"] = {
                "status": "success",
                "payloads_generated": len(test_payloads),
                "error_detection_rate": detection_count / len(test_responses)
            }
            
            return True
            
        except Exception as e:
            print(f"[FAIL] SQLi æƒæå™¨æ¸¬è©¦å¤±æ•—: {e}")
            self.results["sqli_test"] = {
                "status": "failed",
                "error": str(e)
            }
            return False
    
    def test_xss_scanner(self):
        """æ¸¬è©¦ XSS æƒæå™¨"""
        print("\n[STEP 3] æ¸¬è©¦ XSS æƒæå™¨...")
        print("-" * 30)
        
        try:
            # æ¸¬è©¦ä¿®å¾©å¾Œçš„ XSS scanner å°å…¥
            from services.features.function_xss.payload_generator import XssPayloadGenerator
            from services.features.function_xss.dom_xss_detector import DomXssDetector
            
            print("[OK] XSS æƒæå™¨çµ„ä»¶å°å…¥æˆåŠŸ")
            
            # å‰µå»ºçµ„ä»¶å¯¦ä¾‹
            payload_gen = XssPayloadGenerator()
            dom_detector = DomXssDetector()
            
            print("[OK] XSS çµ„ä»¶åˆå§‹åŒ–æˆåŠŸ")
            
            # ç”Ÿæˆæ¸¬è©¦ payload
            basic_payloads = payload_gen.generate_basic_payloads()
            advanced_payloads = payload_gen.generate_advanced_payloads()
            
            total_payloads = len(basic_payloads) + len(advanced_payloads)
            print(f"[OK] ç”Ÿæˆäº† {total_payloads} å€‹ XSS payloads")
            print(f"   - åŸºç¤ payloads: {len(basic_payloads)}")
            print(f"   - é«˜ç´š payloads: {len(advanced_payloads)}")
            
            # é¡¯ç¤ºå‰å¹¾å€‹ payload
            print("å‰5å€‹ XSS payloads:")
            for i, payload in enumerate(basic_payloads[:5]):
                print(f"  {i+1}. {payload}")
            
            # æ¸¬è©¦ DOM XSS æª¢æ¸¬
            test_cases = [
                {
                    "payload": "alert(1)",
                    "html": '<script>alert(1)</script><p>test</p>',
                    "should_detect": True
                },
                {
                    "payload": "alert(2)",
                    "html": '<img src=x onerror="alert(2)"><p>test</p>',
                    "should_detect": True
                },
                {
                    "payload": "safe_text",
                    "html": '<p>safe_text in normal context</p>',
                    "should_detect": False
                }
            ]
            
            detection_success = 0
            for case in test_cases:
                result = dom_detector.analyze(
                    payload=case["payload"], 
                    document=case["html"]
                )
                
                detected = result is not None
                expected = case["should_detect"]
                
                if detected == expected:
                    detection_success += 1
                    status = "[OK]" if detected else "[OK]"
                    print(f"{status} DOM æª¢æ¸¬æ­£ç¢º: payload='{case['payload']}', detected={detected}")
                else:
                    print(f"[WARN] DOM æª¢æ¸¬ä¸æº–ç¢º: payload='{case['payload']}', expected={expected}, got={detected}")
            
            print(f"[OK] XSS æª¢æ¸¬æº–ç¢ºç‡: {detection_success}/{len(test_cases)}")
            
            self.results["xss_test"] = {
                "status": "success",
                "basic_payloads": len(basic_payloads),
                "advanced_payloads": len(advanced_payloads),
                "detection_accuracy": detection_success / len(test_cases)
            }
            
            return True
            
        except Exception as e:
            print(f"[FAIL] XSS æƒæå™¨æ¸¬è©¦å¤±æ•—: {e}")
            import traceback
            traceback.print_exc()
            self.results["xss_test"] = {
                "status": "failed",
                "error": str(e)
            }
            return False
    
    def test_ai_dialogue_assistant(self):
        """æ¸¬è©¦ AI å°è©±åŠ©æ‰‹"""
        print("\n[STEP 4] æ¸¬è©¦ AI å°è©±åŠ©æ‰‹...")
        print("-" * 35)
        
        try:
            from services.aiva_common.ai.dialog_assistant import AIVADialogAssistant
            
            assistant = AIVADialogAssistant()
            print("[OK] AI å°è©±åŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸ")
            
            # æ¸¬è©¦æ»²é€æ¸¬è©¦ç›¸é—œæŸ¥è©¢
            test_queries = [
                "å¦‚ä½•é€²è¡ŒXSSæ¸¬è©¦ï¼Ÿ",
                "SQLæ³¨å…¥çš„åŸºæœ¬åŸç†æ˜¯ä»€éº¼ï¼Ÿ",
                "æˆ‘è¦æ¸¬è©¦ä¸€å€‹ç™»éŒ„é é¢çš„å®‰å…¨æ€§",
                "åˆ†æé€™å€‹HTTPéŸ¿æ‡‰æ˜¯å¦æœ‰æ¼æ´"
            ]
            
            successful_responses = 0
            for query in test_queries:
                try:
                    response = assistant.process_query(query)
                    if response and len(response.strip()) > 10:
                        successful_responses += 1
                        print(f"[OK] æŸ¥è©¢æˆåŠŸ: '{query[:30]}...' -> {len(response)} å­—ç¬¦å›æ‡‰")
                    else:
                        print(f"[WARN] æŸ¥è©¢å›æ‡‰ä¸ä½³: '{query[:30]}...'")
                except Exception as e:
                    print(f"[FAIL] æŸ¥è©¢å¤±æ•—: '{query[:30]}...' - {e}")
            
            print(f"[OK] AI åŠ©æ‰‹å›æ‡‰æˆåŠŸç‡: {successful_responses}/{len(test_queries)}")
            
            self.results["ai_dialogue"] = {
                "status": "success",
                "queries_processed": successful_responses,
                "total_queries": len(test_queries),
                "success_rate": successful_responses / len(test_queries)
            }
            
            return successful_responses > 0
            
        except Exception as e:
            print(f"[FAIL] AI å°è©±åŠ©æ‰‹æ¸¬è©¦å¤±æ•—: {e}")
            self.results["ai_dialogue"] = {
                "status": "failed",
                "error": str(e)
            }
            return False
    
    def validate_system_health(self):
        """é©—è­‰ç³»çµ±æ•´é«”å¥åº·ç‹€æ…‹"""
        print("\n[STEP 5] ç³»çµ±æ•´é«”å¥åº·ç‹€æ…‹é©—è­‰...")
        print("-" * 40)
        
        try:
            # æ¸¬è©¦æ ¸å¿ƒæ¨¡çµ„å°å…¥
            from services.aiva_common.enums import Severity, Confidence, VulnerabilityType
            from services.aiva_common.schemas import FindingPayload, ScanStartPayload
            
            print("[OK] aiva_common æ ¸å¿ƒæ¨¡çµ„å°å…¥æˆåŠŸ")
            
            # æ¸¬è©¦æšèˆ‰å€¼
            severity_values = [s.value for s in Severity]
            confidence_values = [c.value for c in Confidence]
            vuln_types = [v.value for v in VulnerabilityType]
            
            print(f"[OK] åš´é‡ç¨‹åº¦æšèˆ‰: {len(severity_values)} å€‹å€¼")
            print(f"[OK] å¯ä¿¡åº¦æšèˆ‰: {len(confidence_values)} å€‹å€¼")
            print(f"[OK] æ¼æ´é¡å‹æšèˆ‰: {len(vuln_types)} å€‹å€¼")
            
            # æ¸¬è©¦æ•¸æ“šçµæ§‹å‰µå»º
            test_finding = FindingPayload(
                finding_id="TEST-001",
                title="æ¸¬è©¦æ¼æ´",
                severity=Severity.HIGH,
                confidence=Confidence.FIRM,
                description="é€™æ˜¯ä¸€å€‹æ¸¬è©¦æ¼æ´"
            )
            
            print("[OK] FindingPayload æ•¸æ“šçµæ§‹å‰µå»ºæˆåŠŸ")
            
            test_scan = ScanStartPayload(
                scan_id="SCAN-001",
                target="https://example.com"
            )
            
            print("[OK] ScanStartPayload æ•¸æ“šçµæ§‹å‰µå»ºæˆåŠŸ")
            
            # æ¸¬è©¦åºåˆ—åŒ–
            finding_json = test_finding.model_dump_json()
            scan_json = test_scan.model_dump_json()
            
            print(f"[OK] æ•¸æ“šçµæ§‹åºåˆ—åŒ–æˆåŠŸ: {len(finding_json)} + {len(scan_json)} å­—ç¬¦")
            
            self.results["system_validation"] = {
                "status": "success",
                "enums_loaded": len(severity_values) + len(confidence_values) + len(vuln_types),
                "schemas_working": True,
                "serialization_working": True
            }
            
            return True
            
        except Exception as e:
            print(f"[FAIL] ç³»çµ±å¥åº·ç‹€æ…‹é©—è­‰å¤±æ•—: {e}")
            self.results["system_validation"] = {
                "status": "failed",
                "error": str(e)
            }
            return False
    
    async def run_comprehensive_test(self):
        """åŸ·è¡Œå®Œæ•´çš„æ»²é€æ¸¬è©¦"""
        print(f"é–‹å§‹æ™‚é–“: {time.strftime('%Y-%m-%d %H:%M:%S')}")
        
        # åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦æ­¥é©Ÿ
        test_results = {
            "connectivity": await self.test_connectivity(),
            "sqli_scanner": self.test_sqli_scanner(),
            "xss_scanner": self.test_xss_scanner(),
            "ai_dialogue": self.test_ai_dialogue_assistant(),
            "system_health": self.validate_system_health()
        }
        
        # ç”Ÿæˆæ¸¬è©¦å ±å‘Š
        print("\n" + "=" * 50)
        print("ç¶œåˆæ»²é€æ¸¬è©¦å ±å‘Š")
        print("=" * 50)
        
        total_tests = len(test_results)
        passed_tests = sum(1 for result in test_results.values() if result)
        
        print(f"ç¸½æ¸¬è©¦é …ç›®: {total_tests}")
        print(f"é€šéæ¸¬è©¦: {passed_tests}")
        print(f"æ•´é«”æˆåŠŸç‡: {passed_tests/total_tests:.1%}")
        
        print("\nè©³ç´°çµæœ:")
        for test_name, result in test_results.items():
            status = "[OK]" if result else "[FAIL]"
            print(f"  {status} {test_name.replace('_', ' ').title()}")
        
        # é¡¯ç¤ºå…·é«”çµ±è¨ˆ
        if self.results["sqli_test"].get("status") == "success":
            sqli = self.results["sqli_test"]
            print(f"\nSQLi æƒæå™¨çµ±è¨ˆ:")
            print(f"  - Payloads ç”Ÿæˆ: {sqli.get('payloads_generated', 0)}")
            print(f"  - éŒ¯èª¤æª¢æ¸¬ç‡: {sqli.get('error_detection_rate', 0):.1%}")
        
        if self.results["xss_test"].get("status") == "success":
            xss = self.results["xss_test"]
            print(f"\nXSS æƒæå™¨çµ±è¨ˆ:")
            print(f"  - åŸºç¤ payloads: {xss.get('basic_payloads', 0)}")
            print(f"  - é«˜ç´š payloads: {xss.get('advanced_payloads', 0)}")
            print(f"  - æª¢æ¸¬æº–ç¢ºç‡: {xss.get('detection_accuracy', 0):.1%}")
        
        if self.results["ai_dialogue"].get("status") == "success":
            ai = self.results["ai_dialogue"]
            print(f"\nAI å°è©±åŠ©æ‰‹çµ±è¨ˆ:")
            print(f"  - æŸ¥è©¢è™•ç†: {ai.get('queries_processed', 0)}/{ai.get('total_queries', 0)}")
            print(f"  - æˆåŠŸç‡: {ai.get('success_rate', 0):.1%}")
        
        print(f"\nçµæŸæ™‚é–“: {time.strftime('%Y-%m-%d %H:%M:%S')}")
        
        if passed_tests == total_tests:
            print("\n[SUCCESS] æ‰€æœ‰æ¸¬è©¦é€šéï¼AIVA ç³»çµ±æº–å‚™å°±ç·’ï¼Œå¯ä»¥é€²è¡Œå¯¦æˆ°æ»²é€æ¸¬è©¦ï¼")
            return True
        else:
            print(f"\n[WARNING] {total_tests - passed_tests} å€‹æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç›¸é—œçµ„ä»¶")
            return False

async def main():
    """ä¸»åŸ·è¡Œå‡½æ•¸"""
    runner = ComprehensivePentestRunner()
    success = await runner.run_comprehensive_test()
    
    if success:
        print("\n" + "="*50)
        print("ğŸ¯ å¯¦æˆ°æ¨¡å¼æº–å‚™å°±ç·’")
        print("="*50)
        print("ç³»çµ±å·²é€šéæ‰€æœ‰é©—è­‰ï¼Œå¯ä»¥é–‹å§‹å¯¦éš›çš„æ»²é€æ¸¬è©¦ä»»å‹™ï¼š")
        print("1. SQLi æƒæå™¨å·²å°±ç·’ï¼Œå¯å°å¯¦éš›ç›®æ¨™é€²è¡ŒSQLæ³¨å…¥æª¢æ¸¬")
        print("2. XSS æƒæå™¨å·²å°±ç·’ï¼Œå¯å°å¯¦éš›ç›®æ¨™é€²è¡Œè·¨ç«™è…³æœ¬æª¢æ¸¬")
        print("3. AI å°è©±åŠ©æ‰‹å¯å”åŠ©åˆ†ææ»²é€æ¸¬è©¦çµæœ")
        print("4. æ‰€æœ‰æ•¸æ“šçµæ§‹å’Œæšèˆ‰æ­£å¸¸å·¥ä½œ")
        print("\næº–å‚™å°ä»¥ä¸‹ç›®æ¨™é€²è¡Œå¯¦æˆ°æ¸¬è©¦:")
        for target in runner.test_targets:
            print(f"  - {target}")
    
    return success

if __name__ == "__main__":
    # åŸ·è¡Œç¶œåˆæ¸¬è©¦
    asyncio.run(main())