flowchart TB
    n1([開始])
    n2([結束])
    n3[&amp;&#35;39;\n        Adjust global and per-host rates b...]
    n4[self._touch_host&#40;host&#41;]
    n5[global_penalty = 1.0]
    n6[host_penalty = 1.0]
    n7[base_penalty = 1.0]
    n8[global_boost = 1.0]
    n9[host_boost = 1.0]
    n10[base_boost = 1.0]
    n11[ra_until = None]
    n12[try]
    n13{if headers and any&#40;&#40;k.lower&#40;&#41; ...}
    n14[ra_val = next&#40;&#40;headers&#91;k&#93; for...]
    n15{if ra_val is not None}
    n16[ra_val = str&#40;ra_val&#41;.strip&#40;&#41;]
    n17{if re.fullmatch&#40;&amp;&#35;39;\\d+&amp;&#35;39;, ra_va...}
    n18[ra_until = time.monotonic&#40;&#41; + f...]
    n19[try]
    n20[dt = parsedate_to_datetim...]
    n21[ra_until = time.monotonic&#40;&#41; + m...]
    n22[]
    n23[except Exception]
    n24[ra_until = None]
    n25[]
    n26[]
    n27[]
    n28[]
    n29[except Exception]
    n30[ra_until = None]
    n31{if ra_until is not None}
    n32[prev = self._cooldown_until...]
    n33[self._cooldown_until&#91;host&#93; = max&#40;prev or 0.0,...]
    n34[with contextli...]
    n35[self._log.info&#40;&amp;&#35;39;ratelimiter.cooldown_begi...]
    n36[base_penalty *= 1.5]
    n37[host_penalty *= 2.0]
    n38[]
    n39{if status_code is not None}
    n40{if status_code == 429}
    n41[global_penalty = min&#40;global_penalty, ...]
    n42[host_penalty = min&#40;host_penalty, 0....]
    n43[base_penalty = min&#40;base_penalty, 0....]
    n44{if status_code in &#123;503, 504&#125;}
    n45[global_penalty = min&#40;global_penalty, ...]
    n46[host_penalty = min&#40;host_penalty, 0....]
    n47[base_penalty = min&#40;base_penalty, 0....]
    n48{if 500 &amp;lt;= status_code &amp;lt; 600}
    n49[global_penalty = min&#40;global_penalty, ...]
    n50[host_penalty = min&#40;host_penalty, 0....]
    n51[base_penalty = min&#40;base_penalty, 0....]
    n52{if 200 &amp;lt;= status_code &amp;lt; 300}
    n53[global_boost = max&#40;global_boost, 1....]
    n54[host_boost = max&#40;host_boost, 1.08...]
    n55[base_boost = max&#40;base_boost, 1.02...]
    n56[]
    n57[]
    n58[]
    n59[]
    n60[]
    n61{if latency is not None}
    n62{if latency &amp;gt; 5.0}
    n63[global_penalty = min&#40;global_penalty, ...]
    n64[host_penalty = min&#40;host_penalty, 0....]
    n65[base_penalty = min&#40;base_penalty, 0....]
    n66{if latency &amp;gt; 2.5}
    n67[global_penalty = min&#40;global_penalty, ...]
    n68[host_penalty = min&#40;host_penalty, 0....]
    n69[base_penalty = min&#40;base_penalty, 0....]
    n70{if latency &amp;lt; 0.3}
    n71[global_boost = max&#40;global_boost, 1....]
    n72[host_boost = max&#40;host_boost, 1.1&#41;]
    n73[base_boost = max&#40;base_boost, 1.04...]
    n74{if latency &amp;lt; 0.6}
    n75[global_boost = max&#40;global_boost, 1....]
    n76[host_boost = max&#40;host_boost, 1.05...]
    n77[base_boost = max&#40;base_boost, 1.02...]
    n78[]
    n79[]
    n80[]
    n81[]
    n82[]
    n83{if global_penalty &amp;lt; 1.0 or hos...}
    n84{if global_penalty &amp;lt; 1.0}
    n85[self._scale_global&#40;global_penalty&#41;]
    n86[]
    n87{if base_penalty &amp;lt; 1.0}
    n88[self._scale_per_host_base&#40;base_penalty&#41;]
    n89[]
    n90{if host_penalty &amp;lt; 1.0}
    n91[self._scale_host&#40;host, host_penalty&#41;]
    n92[]
    n93[return]
    n94[]
    n95{if global_boost &amp;gt; 1.0}
    n96[self._scale_global&#40;global_boost&#41;]
    n97[]
    n98{if base_boost &amp;gt; 1.0}
    n99[self._scale_per_host_base&#40;base_boost&#41;]
    n100[]
    n101{if host_boost &amp;gt; 1.0}
    n102[self._scale_host&#40;host, host_boost&#41;]
    n103[]
    n104[try]
    n105{if status_code and 200 &amp;lt;= int&#40;...}
    n106[until = self._cooldown_until...]
    n107{if until}
    n108[now = time.monotonic&#40;&#41;]
    n109{if now + max&#40;0.0, latency&#41; * 2...}
    n110[self._cooldown_until.pop&#40;host, None&#41;]
    n111[self._log.info&#40;&amp;&#35;39;ratelimiter.cooldown_end ...]
    n112[]
    n113[]
    n114[]
    n115[]
    n116[except Exception]
    n117[pass]
    n1 --> n3
    n3 --> n4
    n4 --> n5
    n5 --> n6
    n6 --> n7
    n7 --> n8
    n8 --> n9
    n9 --> n10
    n10 --> n11
    n11 --> n12
    n12 --> n13
    n12 --> n29
    n13 -->|Yes| n14
    n13 -->|No| n27
    n14 --> n15
    n15 -->|Yes| n16
    n15 -->|No| n26
    n16 --> n17
    n17 -->|Yes| n18
    n17 -->|No| n19
    n18 --> n25
    n19 --> n20
    n19 --> n23
    n20 --> n21
    n21 --> n22
    n22 --> n25
    n23 --> n24
    n24 --> n22
    n25 --> n26
    n26 --> n27
    n27 --> n28
    n28 --> n31
    n29 --> n30
    n30 --> n28
    n31 -->|Yes| n32
    n31 -->|No| n38
    n32 --> n33
    n33 --> n34
    n34 --> n35
    n35 --> n36
    n36 --> n37
    n37 --> n38
    n38 --> n39
    n39 -->|Yes| n40
    n39 -->|No| n60
    n40 -->|Yes| n41
    n40 -->|No| n44
    n41 --> n42
    n42 --> n43
    n43 --> n59
    n44 -->|Yes| n45
    n44 -->|No| n48
    n45 --> n46
    n46 --> n47
    n47 --> n58
    n48 -->|Yes| n49
    n48 -->|No| n52
    n49 --> n50
    n50 --> n51
    n51 --> n57
    n52 -->|Yes| n53
    n52 -->|No| n56
    n53 --> n54
    n54 --> n55
    n55 --> n56
    n56 --> n57
    n57 --> n58
    n58 --> n59
    n59 --> n60
    n60 --> n61
    n61 -->|Yes| n62
    n61 -->|No| n82
    n62 -->|Yes| n63
    n62 -->|No| n66
    n63 --> n64
    n64 --> n65
    n65 --> n81
    n66 -->|Yes| n67
    n66 -->|No| n70
    n67 --> n68
    n68 --> n69
    n69 --> n80
    n70 -->|Yes| n71
    n70 -->|No| n74
    n71 --> n72
    n72 --> n73
    n73 --> n79
    n74 -->|Yes| n75
    n74 -->|No| n78
    n75 --> n76
    n76 --> n77
    n77 --> n78
    n78 --> n79
    n79 --> n80
    n80 --> n81
    n81 --> n82
    n82 --> n83
    n83 -->|Yes| n84
    n83 -->|No| n94
    n84 -->|Yes| n85
    n84 -->|No| n86
    n85 --> n86
    n86 --> n87
    n87 -->|Yes| n88
    n87 -->|No| n89
    n88 --> n89
    n89 --> n90
    n90 -->|Yes| n91
    n90 -->|No| n92
    n91 --> n92
    n92 --> n93
    n93 --> n94
    n94 --> n95
    n95 -->|Yes| n96
    n95 -->|No| n97
    n96 --> n97
    n97 --> n98
    n98 -->|Yes| n99
    n98 -->|No| n100
    n99 --> n100
    n100 --> n101
    n101 -->|Yes| n102
    n101 -->|No| n103
    n102 --> n103
    n103 --> n104
    n104 --> n105
    n104 --> n116
    n105 -->|Yes| n106
    n105 -->|No| n114
    n106 --> n107
    n107 -->|Yes| n108
    n107 -->|No| n113
    n108 --> n109
    n109 -->|Yes| n110
    n109 -->|No| n112
    n110 --> n111
    n111 --> n112
    n112 --> n113
    n113 --> n114
    n114 --> n115
    n115 --> n2
    n116 --> n117
    n117 --> n115