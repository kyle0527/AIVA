# 依賴管理最佳實踐

## 🎯 **總體原則**

### **1. 最小化原則**
- ✅ 只安裝必要的依賴
- ✅ 避免"廚房水槽"方法
- ✅ 定期清理未使用的套件

### **2. 環境隔離**
- ✅ 使用虛擬環境
- ✅ 避免系統級安裝
- ✅ 容器化部署環境

### **3. 版本控制**
- ✅ 固定關鍵依賴版本
- ✅ 允許次要版本更新
- ✅ 定期安全更新

---

## 📦 **依賴分級管理**

### **第一級：核心依賴** (不可缺少)
```toml
[project.dependencies]
fastapi = "==0.115.0"      # 固定版本，避免循環導入
pydantic = ">=2.7.0,<3.0"  # 主版本固定
sqlalchemy = ">=2.0.31"    # 允許次要更新
```

### **第二級：功能依賴** (按需安裝)
```toml
[project.optional-dependencies]
ai = ["scikit-learn>=1.3.0", "torch>=2.1.0"]
monitoring = ["prometheus-client>=0.20"]
```

### **第三級：開發依賴** (開發環境)
```toml
dev = ["pytest>=8.0.0", "black>=24.0.0", "mypy>=1.8.0"]
```

---

## 🔄 **依賴生命週期**

### **引入新依賴流程**
1. **評估必要性**: 是否有替代方案？
2. **安全檢查**: 檢查已知漏洞
3. **相容性測試**: 與現有依賴是否衝突
4. **性能影響**: 對啟動時間和記憶體的影響
5. **維護狀況**: 套件是否持續維護

### **依賴更新流程**
1. **檢查更新日誌**: 瞭解變更內容
2. **本地測試**: 在開發環境測試
3. **回歸測試**: 執行完整測試套件
4. **段階式部署**: 先在測試環境驗證

### **依賴移除流程**
1. **影響分析**: 檢查是否有其他依賴
2. **程式碼掃描**: 確認沒有導入語句
3. **測試驗證**: 確保功能正常
4. **文件更新**: 更新相關文件

---

## ⚠️ **常見陷阱避免**

### **版本地獄**
```bash
# ❌ 錯誤做法
pip install package  # 安裝最新版本可能不相容

# ✅ 正確做法  
pip install package>=1.0.0,<2.0.0  # 限制主版本範圍
```

### **隱性依賴**
```python
# ❌ 錯誤做法
import requests  # 未在 requirements.txt 中明確聲明

# ✅ 正確做法
# 在 pyproject.toml 中明確聲明所有直接依賴
```

### **開發依賴污染**
```bash
# ❌ 錯誤做法
pip install pytest  # 在生產環境安裝開發工具

# ✅ 正確做法
pip install .[dev]  # 明確安裝開發依賴組
```

---

## 📊 **監控指標**

### **依賴健康度**
- 📈 **更新頻率**: 套件最後更新時間
- 🐛 **安全漏洞**: 已知 CVE 數量
- 👥 **社群活躍度**: GitHub stars, contributors
- 📝 **文件完整度**: 是否有詳細文件

### **專案依賴度**
- 🔗 **依賴深度**: 間接依賴層數
- 📦 **依賴數量**: 總依賴套件數
- 💾 **安裝大小**: 虛擬環境總大小
- ⏱️ **啟動時間**: 導入所有依賴的耗時

---

## 🛠️ **工具推薦**

### **依賴分析工具**
```bash
# 檢查過時依賴
pip list --outdated

# 安全漏洞掃描
pip audit

# 依賴樹視覺化
pipdeptree

# 未使用依賴檢測
pip-autoremove --list
```

### **版本管理工具**
```bash
# 版本固定
pip freeze > requirements-lock.txt

# 版本範圍檢查
pip-check

# 依賴更新建議
pipenv update --outdated
```

---

## 📋 **檢查清單模板**

### **每月依賴檢查**
- [ ] 執行 `pip audit` 檢查安全漏洞
- [ ] 檢查 `pip list --outdated` 過時套件
- [ ] 查看依賴套件的 GitHub 活躍度
- [ ] 執行完整測試套件
- [ ] 更新依賴分析文件

### **新功能開發**
- [ ] 評估是否需要新依賴
- [ ] 檢查現有依賴是否足夠
- [ ] 如需新依賴，按流程評估
- [ ] 更新 `pyproject.toml`
- [ ] 執行依賴相容性測試

### **版本發布前**
- [ ] 固定所有依賴版本
- [ ] 執行安全掃描
- [ ] 測試依賴安裝過程
- [ ] 驗證容器化環境
- [ ] 產生依賴清單文件

---

## 🚀 **自動化建議**

### **CI/CD 整合**
```yaml
# GitHub Actions 範例
- name: 依賴安全檢查
  run: pip audit

- name: 依賴更新檢查  
  run: pip list --outdated --format=json

- name: 測試依賴安裝
  run: pip install -e .[dev]
```

### **Pre-commit Hooks**
```yaml
# .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: pip-audit
        name: 依賴安全檢查
        entry: pip-audit
        language: system
```

---

## 🎯 **AIVA 專案特定建議**

### **當前狀況評估**
- ✅ **依賴數量適中**: 95個套件屬於合理範圍
- ✅ **版本控制良好**: 核心依賴版本固定
- ✅ **環境隔離完整**: 虛擬環境與系統環境分離
- ⚠️ **可選依賴待整理**: AI 依賴可按需安裝

### **改進建議**
1. **建立依賴分組**: 將相關依賴歸類到 optional-dependencies
2. **定期依賴審查**: 每季度檢查依賴的必要性
3. **自動化監控**: 設置依賴更新和安全告警
4. **文件同步更新**: 依賴變更時同步更新文件