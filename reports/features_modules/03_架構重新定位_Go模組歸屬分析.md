# 🔄 架構重新定位：Go 模組歸屬分析

**報告編號**: ARCH-001  
**日期**: 2025年11月6日  
**狀態**: 🔄 架構重構 - 模組歸屬重新定位  
**影響範圍**: Go 語言模組群組 + Scan/Features 模組架構

---

## 🎯 問題背景

### **當前問題**
根據實戰滲透測試流程分析，發現當前 Go 模組在 Features 中的定位存在概念性錯誤：

```
當前配置 ❌:
Features 模組 (深度攻擊) 包含:
├── SSRF_GO      # 應該做大範圍掃描，不是深度攻擊
├── CSPM_GO      # 應該做雲資源枚舉，不是深度攻擊  
├── SCA_GO       # 應該做依賴掃描，不是深度攻擊
└── AUTHN_GO     # 認證深度測試 ✅ 正確定位
```

### **實戰流程分析**
正確的滲透測試流程應該是：

1. **廣度掃描階段** (Scan 模組)：
   - 大範圍發現目標和服務
   - 快速識別潛在攻擊面
   - 高併發、高吞吐量掃描

2. **深度攻擊階段** (Features 模組)：
   - 針對發現的目標進行精準攻擊
   - 複雜邏輯漏洞檢測
   - 深度利用和驗證

---

## 📊 Go 模組能力分析

### **Go 語言核心優勢**
- **高併發能力**: Goroutine 輕量級並發
- **網路效能**: 高效 HTTP 客戶端
- **資源效率**: 低記憶體占用
- **快速編譯**: 適合大規模部署

### **各 Go 模組特性分析**

#### **🌐 SSRF_GO** - 建議移入 Scan 模組
```
現況: Features 模組 (2/4 組件)
功能: SSRF 漏洞檢測
特性: 高併發網路請求、大量 URL 測試

💡 重新定位理由:
✅ 適合: 大範圍掃描數千個 URL，發現可能的 SSRF 點
❌ 不適合: 單個目標的深度 SSRF 利用 (這是 Python SSRF 的職責)

建議職責:
• 快速掃描大量端點
• 併發測試內網可達性  
• 批量檢測 SSRF 候選點
• 為 Features/SSRF 提供目標清單
```

#### **☁️ CSPM_GO** - 建議移入 Scan 模組
```
現況: Features 模組 (1/4 組件)
功能: 雲安全態勢管理
特性: 雲資源枚舉、配置檢查

💡 重新定位理由:
✅ 適合: 大規模雲資源發現和初步配置檢查
❌ 不適合: 深度漏洞利用 (需要複雜邏輯)

建議職責:
• 並發掃描數百個雲服務
• 快速識別配置錯誤
• 資源清單建立
• 為深度檢測提供目標
```

#### **📦 SCA_GO** - 建議移入 Scan 模組
```
現況: Features 模組 (1/4 組件)  
功能: 軟體組件分析
特性: 依賴庫掃描、版本檢查

💡 重新定位理由:
✅ 適合: 大量專案的依賴快速掃描
❌ 不適合: 漏洞深度分析和利用

建議職責:
• 併發掃描大量 package.json/go.mod 等
• 快速版本漏洞匹配
• 依賴關係建立
• 為漏洞利用提供目標列表
```

#### **🔐 AUTHN_GO** - 保留在 Features 模組 ✅
```
現況: Features 模組 (2/4 組件)
功能: 認證繞過檢測  
特性: 會話管理、認證測試

💡 定位正確理由:
✅ 深度測試: 需要複雜的認證邏輯測試
✅ 精準攻擊: 針對特定認證機制的深度利用
✅ 狀態管理: 需要維護複雜的會話狀態

保持職責:
• 深度認證機制測試
• 複雜的令牌操作
• 會話劫持和偽造
• 多步驟認證繞過
```

---

## 🏗️ 建議的新架構

### **📡 Scan 模組** (廣度掃描 + 快速發現)
```
services/scan/
├── 🐍 aiva_scan/          # Python 核心掃描邏輯
├── 📘 aiva_scan_node/     # TypeScript 動態瀏覽器掃描
├── 🦀 info_gatherer_rust/ # Rust 高效能資訊收集
└── 🐹 go_scanners/        # Go 高併發掃描器群 (新增)
    ├── ssrf_scanner/      # SSRF_GO 廣度掃描
    ├── cspm_scanner/      # CSPM_GO 雲資源掃描
    └── sca_scanner/       # SCA_GO 依賴掃描
```

### **🎯 Features 模組** (深度檢測 + 精準攻擊)
```
services/features/
├── 🐍 Python 群組        # 複雜邏輯漏洞檢測
│   ├── function_xss/     # XSS 深度檢測
│   ├── function_sqli/    # SQL 注入深度檢測
│   ├── function_ssrf/    # SSRF 深度利用
│   ├── function_idor/    # IDOR 深度測試
│   └── function_postex/  # 後滲透利用
├── 🦀 Rust 群組          # 高效能專門檢測
│   └── function_crypto/  # 密碼學弱點檢測
└── 🐹 Go 群組            # 特定高併發深度檢測
    └── function_authn_go/ # 認證深度測試
```

---

## 🔄 遷移策略

### **第一階段: 基礎架構準備** (1週)
- [ ] 創建 `services/scan/go_scanners/` 目錄結構
- [ ] 實現 GO 掃描器共享組件 (AMQP, SARIF, Base)
- [ ] 建立統一的掃描器基礎類和工作器模式
- [ ] 擴展 `unified_scan_engine.py` 支援 GO 掃描器調用

### **第二階段: 掃描器遷移** (2-3週)
- [ ] 遷移 SSRF_GO → `go_scanners/ssrf_scanner/` (廣度 SSRF 掃描)
- [ ] 遷移 CSPM_GO → `go_scanners/csmp_scanner/` (雲配置批量掃描)
- [ ] 遷移 SCA_GO → `go_scanners/sca_scanner/` (依賴組件大規模掃描)
- [ ] 適配新的消息隊列接口和 SARIF 2.1.0 輸出格式
- [ ] 保留 AUTHN_GO 在 Features，補全缺失的 Detector+Engine 組件

### **第三階段: 四語言整合測試** (1週)
- [ ] Python/TypeScript/Rust/Go 四語言掃描引擎協調測試
- [ ] 統一掃描引擎 (UnifiedScanEngine) 端到端測試
- [ ] SARIF 格式一致性驗證和跨語言結果聚合
- [ ] 大規模併發掃描性能基準測試 (1000+ 目標)

---

## 💪 團隊分工建議

### **Team A - Scan 模組架構** (1人，1週)
- **Go 架構專家**
  - 設計 Go 掃描器統一框架
  - 制定 Scan 模組接口標準
  - 跨語言通信協議設計

### **Team B - 模組遷移** (2人，2-3週)
- **Go 遷移專家 x2**
  - 負責 3 個 Go 模組的代碼遷移
  - 適配新的 Scan 框架接口
  - 優化併發掃描效能

### **Team C - 整合測試** (1人，1週)
- **系統整合專家**
  - 跨模組數據流測試
  - 效能對比和優化
  - 端對端場景驗證

---

## 📈 預期效益

### **四語言統一掃描引擎架構**
- ✅ **語言優勢最大化**: Python 複雜邏輯 + TypeScript 動態渲染 + Rust 極致性能 + Go 高併發掃描
- ✅ **工作流程標準化**: Scan 模組 (廣度發現) → Features 模組 (深度攻擊)
- ✅ **SARIF 標準化**: 四語言統一輸出 SARIF 2.1.0 格式，業界標準兼容

### **性能和規模提升**
- 🚀 **併發掃描能力**: Go 掃描器支持 1000+ URL 並發掃描，效率提升 10-50 倍
- 📊 **大規模掃描**: 支持企業級大規模資產掃描 (數萬個目標)
- ⚡ **資源優化**: 四語言引擎合理分配 CPU/內存/網路資源

### **開發和維護效率**
- 👥 **專業化分工**: 掃描專家團隊 vs 攻擊研究團隊職責清晰
- 🔄 **獨立並行開發**: 四語言引擎團隊可並行開發和迭代
- 🧪 **模組化測試**: 掃描測試、攻擊測試、整合測試獨立進行
- 📋 **標準化接口**: 統一的消息隊列和 SARIF 接口降低維護複雜度

---

## ⚠️ 風險評估

### **高風險項目**
1. **數據格式相容性**
   - **風險**: Scan → Features 數據傳遞格式不匹配
   - **應對**: 統一使用 AIVA Common 標準格式
   
2. **效能回歸**
   - **風險**: 遷移後效能不如預期
   - **應對**: 遷移前建立基準測試，遷移後對比驗證
   
3. **功能缺失**
   - **風險**: 遷移過程中遺失部分功能
   - **應對**: 詳細的功能清單和測試用例

### **應對策略**
- 📋 **詳細規劃**: 制定細緻的遷移檢查清單
- 🧪 **漸進遷移**: 一個模組一個模組地遷移和測試
- 🔄 **回滾計劃**: 保留原有架構作為備份方案

---

## 🎯 成功指標

### **架構目標**
- [ ] Scan 模組包含 4 種語言的掃描器
- [ ] Features 模組專注深度檢測
- [ ] 跨模組數據流順暢
- [ ] 整體效能提升 20%+

### **技術目標**
- [ ] Go 掃描器併發效能提升 10x+
- [ ] Features 檢測準確率提升 15%+
- [ ] 整體架構複雜度降低 30%
- [ ] 開發團隊分工明確，並行效率提升

---

**報告結論**: 將 SSRF_GO、CSPM_GO、SCA_GO 遷移到 Scan 模組，構建 **Python + TypeScript + Rust + Go** 四語言統一掃描引擎，AUTHN_GO 保留在 Features 模組進行深度認證測試。此架構調整完全符合實戰滲透測試流程（廣度掃描 → 深度攻擊），充分發揮各語言技術優勢，建立現代化的企業級掃描架構。

**緊急執行建議**: 🔥 **極高優先級** - 此架構重新定位是所有後續掃描功能開發的基礎架構，必須優先於其他模組完善工作。建議立即啟動遷移計劃，預計 4 週內完成四語言統一掃描引擎的建設。

**技術價值**: 建成後的四語言掃描引擎將成為 AIVA 的核心競爭力，支持世界級的大規模併發掃描能力，為企業安全提供頂級的技術保障。