#!/usr/bin/env python3
"""
AIVA é¶å ´å¯¦æˆ°æ¸¬è©¦è…³æœ¬
ä½¿ç”¨ç™¼ç¾çš„10å€‹æƒæå™¨å°çœŸå¯¦ç›®æ¨™é€²è¡Œå®‰å…¨æ¸¬è©¦
"""

import asyncio
import sys
import json
import time
from pathlib import Path

# å°å…¥å¿…è¦çš„æ¨¡çµ„
from services.aiva_common.enums import ModuleName
from dataclasses import dataclass
from typing import List, Dict, Any

# è¨­ç½®å°ˆæ¡ˆæ ¹ç›®éŒ„
PROJECT_ROOT = Path(__file__).resolve().parent
sys.path.insert(0, str(PROJECT_ROOT))

@dataclass
class TestTarget:
    name: str
    url: str
    expected_vulns: List[str]
    description: str

@dataclass
class ScanResult:
    scanner_name: str
    target_url: str
    findings: List[Dict]
    success: bool
    execution_time: float
    error_message: str = ""

class AIVAPentestRunner:
    def __init__(self):
        self.results: List[ScanResult] = []
        self.targets = [
            TestTarget(
                name="HttpBin",
                url="http://httpbin.org",
                expected_vulns=["info_gathering"],
                description="HTTP æ¸¬è©¦æœå‹™ï¼Œé©åˆè³‡è¨Šæ”¶é›†æ¸¬è©¦"
            ),
            TestTarget(
                name="HttpBin POST",
                url="http://httpbin.org/post",
                expected_vulns=["sqli", "xss"],
                description="POST ç«¯é»ï¼Œé©åˆæ³¨å…¥æ¸¬è©¦"
            ),
            TestTarget(
                name="JSONPlaceholder",
                url="https://jsonplaceholder.typicode.com/posts/1",
                expected_vulns=["sqli", "idor"],
                description="å‡ REST APIï¼Œé©åˆ IDOR å’Œ SQLi æ¸¬è©¦"
            ),
            TestTarget(
                name="Local Test",
                url="http://127.0.0.1:8080",
                expected_vulns=["all"],
                description="æœ¬åœ°æ¸¬è©¦æœå‹™ (å¦‚æœå¯ç”¨)"
            )
        ]
    
    async def test_sqli_scanner(self, target: TestTarget) -> ScanResult:
        """æ¸¬è©¦SQLæ³¨å…¥æƒæå™¨"""
        print(f"  ğŸ” æ¸¬è©¦ SQL æ³¨å…¥æƒæå™¨ - ç›®æ¨™: {target.url}")
        
        start_time = time.time()
        try:
            from services.features.function_sqli.worker import SqliWorkerService
            # çµ±ä¸€ä½¿ç”¨ aiva_common.schemas.tasks ä½œç‚ºå–®ä¸€äº‹å¯¦ä¾†æº
            from services.aiva_common.schemas.tasks import (
                FunctionTaskPayload, 
                FunctionTaskTarget, 
                FunctionTaskContext, 
                FunctionTaskTestConfig
            )
            from services.aiva_common.schemas import MessageHeader
            
            # å‰µå»ºä»»å‹™ç›®æ¨™
            task_target = FunctionTaskTarget(
                url=target.url,
                method="GET",
                parameter_location="url"
            )
            
            task_context = FunctionTaskContext()
            test_config = FunctionTaskTestConfig(
                payloads=["<script>alert('xss')</script>", "javascript:alert('xss')"]
            )
            
            task = FunctionTaskPayload(
                task_id=f"task-{int(time.time())}",
                scan_id="pentest-scan-001",
                target=task_target,
                context=task_context,
                strategy="fast",  # ä½¿ç”¨å¿«é€Ÿæ¨¡å¼é¿å…éé•·ç­‰å¾…
                priority=5,
                test_config=test_config
            )
            
            # åŸ·è¡Œæƒæ
            service = SqliWorkerService()
            context = await service.process_task(task)
            
            execution_time = time.time() - start_time
            
            # æå–çµæœ
            findings = []
            if hasattr(context, 'findings') and context.findings:
                findings = [f.model_dump() if hasattr(f, 'model_dump') else f.__dict__ for f in context.findings]
            
            return ScanResult(
                scanner_name="Function SQLi Scanner",
                target_url=target.url,
                findings=findings,
                success=True,
                execution_time=execution_time
            )
            
        except Exception as e:
            execution_time = time.time() - start_time
            return ScanResult(
                scanner_name="Function SQLi Scanner",
                target_url=target.url,
                findings=[],
                success=False,
                execution_time=execution_time,
                error_message=str(e)
            )
    
    async def test_xss_scanner(self, target: TestTarget) -> ScanResult:
        """æ¸¬è©¦XSSæƒæå™¨"""
        print(f"  ğŸ” æ¸¬è©¦ XSS æƒæå™¨ - ç›®æ¨™: {target.url}")
        
        start_time = time.time()
        try:
            # å˜—è©¦å°å…¥XSSæƒæå™¨
            from services.features.function_xss import worker as xss_worker
            
            # é€™åªæ˜¯ç¤ºä¾‹ï¼Œå¯¦éš›å¯¦ç¾å¯èƒ½ä¸åŒ
            # å‰µå»ºç°¡å–®çš„ä»»å‹™å°è±¡
            class SimpleTask:
                def __init__(self, url, strategy="normal"):
                    self.task_id = f"xss-test-{int(time.time())}"
                    self.target = url
                    self.strategy = strategy
                    self.scan_id = "pentest-scan-001"
            
            task = SimpleTask(target.url, "fast")
            
            # æª¢æŸ¥å¯ç”¨çš„è™•ç†æ–¹æ³•ä¸¦ä½¿ç”¨é˜²å‘†æ©Ÿåˆ¶
            process_fn = getattr(xss_worker, 'process_task_dict', None) or getattr(xss_worker, 'process_task', None)
            if process_fn is None:
                raise AttributeError("XSS worker æ²’æœ‰å¯ç”¨çš„è™•ç†æ–¹æ³• (process_task_dict æˆ– process_task)")
            
            result = await process_fn(task)
            findings = result.get('findings', []) if isinstance(result, dict) else []
            
            execution_time = time.time() - start_time
            
            return ScanResult(
                scanner_name="Function XSS Scanner",
                target_url=target.url,
                findings=findings,
                success=True,
                execution_time=execution_time
            )
            
        except Exception as e:
            execution_time = time.time() - start_time
            return ScanResult(
                scanner_name="Function XSS Scanner",
                target_url=target.url,
                findings=[],
                success=False,
                execution_time=execution_time,
                error_message=str(e)
            )
    
    async def test_info_gatherer(self, target: TestTarget) -> ScanResult:
        """æ¸¬è©¦è³‡è¨Šæ”¶é›†å™¨ï¼ˆRustç‰ˆæœ¬ï¼‰"""
        print(f"  ğŸ” æ¸¬è©¦ Info Gatherer (Rust) - ç›®æ¨™: {target.url}")
        
        start_time = time.time()
        try:
            # å˜—è©¦åŸ·è¡ŒRustè³‡è¨Šæ”¶é›†å™¨
            import subprocess
            import json
            
            # æª¢æŸ¥æ˜¯å¦æœ‰RuståŸ·è¡Œæª”
            rust_binary = PROJECT_ROOT / "services" / "features" / "info_gatherer_rust" / "target" / "release" / "info_gatherer"
            
            if rust_binary.exists():
                # åŸ·è¡ŒRustç¨‹å¼
                result = subprocess.run([
                    str(rust_binary),
                    target.url
                ], capture_output=True, text=True, timeout=30)
                
                findings = []
                if result.returncode == 0 and result.stdout:
                    try:
                        output_data = json.loads(result.stdout)
                        findings = [output_data] if output_data else []
                    except json.JSONDecodeError:
                        findings = [{"raw_output": result.stdout}]
            else:
                findings = [{"status": "Rust binary not found", "note": "éœ€è¦ç·¨è­¯Rustç¨‹å¼"}]
            
            execution_time = time.time() - start_time
            
            return ScanResult(
                scanner_name="Info Gatherer (Rust)",
                target_url=target.url,
                findings=findings,
                success=True,
                execution_time=execution_time
            )
            
        except Exception as e:
            execution_time = time.time() - start_time
            return ScanResult(
                scanner_name="Info Gatherer (Rust)",
                target_url=target.url,
                findings=[],
                success=False,
                execution_time=execution_time,
                error_message=str(e)
            )
    
    async def run_comprehensive_scan(self, target: TestTarget) -> List[ScanResult]:
        """å°å–®å€‹ç›®æ¨™åŸ·è¡Œå…¨é¢æƒæ"""
        print(f"\nğŸ¯ é–‹å§‹æƒæç›®æ¨™: {target.name}")
        print(f"   URL: {target.url}")
        print(f"   æè¿°: {target.description}")
        print("-" * 50)
        
        scan_results = []
        
        # åŸ·è¡Œå„ç¨®æƒæå™¨
        scanners = [
            self.test_sqli_scanner,
            self.test_xss_scanner,
            self.test_info_gatherer,
        ]
        
        for scanner_func in scanners:
            try:
                result = await scanner_func(target)
                scan_results.append(result)
            except Exception as e:
                print(f"    âŒ æƒæå™¨åŸ·è¡Œå¤±æ•—: {e}")
        
        return scan_results
    
    def generate_report(self) -> Dict[str, Any]:
        """ç”Ÿæˆæ¸¬è©¦å ±å‘Š"""
        total_scans = len(self.results)
        successful_scans = len([r for r in self.results if r.success])
        total_findings = sum(len(r.findings) for r in self.results)
        total_time = sum(r.execution_time for r in self.results)
        
        # æŒ‰æƒæå™¨åˆ†çµ„çµ±è¨ˆ
        scanner_stats = {}
        for result in self.results:
            scanner = result.scanner_name
            if scanner not in scanner_stats:
                scanner_stats[scanner] = {
                    "total": 0,
                    "successful": 0,
                    "findings": 0,
                    "avg_time": 0
                }
            
            scanner_stats[scanner]["total"] += 1
            if result.success:
                scanner_stats[scanner]["successful"] += 1
            scanner_stats[scanner]["findings"] += len(result.findings)
            scanner_stats[scanner]["avg_time"] += result.execution_time
        
        # è¨ˆç®—å¹³å‡æ™‚é–“
        for stats in scanner_stats.values():
            if stats["total"] > 0:
                stats["avg_time"] = stats["avg_time"] / stats["total"]
        
        return {
            "summary": {
                "total_scans": total_scans,
                "successful_scans": successful_scans,
                "success_rate": (successful_scans / total_scans * 100) if total_scans > 0 else 0,
                "total_findings": total_findings,
                "total_execution_time": total_time
            },
            "scanner_performance": scanner_stats,
            "detailed_results": [
                {
                    "scanner": r.scanner_name,
                    "target": r.target_url,
                    "success": r.success,
                    "findings_count": len(r.findings),
                    "execution_time": r.execution_time,
                    "error": r.error_message if not r.success else None
                }
                for r in self.results
            ]
        }
    
    async def run_pentest(self):
        """åŸ·è¡Œå®Œæ•´çš„æ»²é€æ¸¬è©¦"""
        print("ğŸ‰ AIVA é¶å ´å¯¦æˆ°æ¸¬è©¦é–‹å§‹")
        print("=" * 60)
        print(f"æ¸¬è©¦ç›®æ¨™æ•¸é‡: {len(self.targets)}")
        print(f"é è¨ˆæƒæå™¨: SQLi, XSS, Info Gatherer")
        print("=" * 60)
        
        # å°æ¯å€‹ç›®æ¨™åŸ·è¡Œæƒæ
        for target in self.targets:
            try:
                target_results = await self.run_comprehensive_scan(target)
                self.results.extend(target_results)
                
                # é¡¯ç¤ºè©²ç›®æ¨™çš„çµæœæ‘˜è¦
                successful = len([r for r in target_results if r.success])
                total_findings = sum(len(r.findings) for r in target_results)
                print(f"   âœ… å®Œæˆ: {successful}/{len(target_results)} æƒææˆåŠŸ")
                print(f"   ğŸ” ç™¼ç¾: {total_findings} å€‹çµæœ")
                
            except Exception as e:
                print(f"   âŒ ç›®æ¨™æƒæå¤±æ•—: {e}")
        
        # ç”Ÿæˆå’Œé¡¯ç¤ºæœ€çµ‚å ±å‘Š
        print("\n" + "=" * 60)
        print("ğŸ“Š AIVA é¶å ´æ¸¬è©¦å ±å‘Š")
        print("=" * 60)
        
        report = self.generate_report()
        
        # é¡¯ç¤ºæ‘˜è¦
        summary = report["summary"]
        print(f"ç¸½æƒææ¬¡æ•¸: {summary['total_scans']}")
        print(f"æˆåŠŸæƒæ: {summary['successful_scans']}")
        print(f"æˆåŠŸç‡: {summary['success_rate']:.1f}%")
        print(f"ç¸½ç™¼ç¾æ•¸: {summary['total_findings']}")
        print(f"ç¸½åŸ·è¡Œæ™‚é–“: {summary['total_execution_time']:.2f} ç§’")
        
        # é¡¯ç¤ºæƒæå™¨æ€§èƒ½
        print("\nğŸ”§ æƒæå™¨æ€§èƒ½:")
        for scanner, stats in report["scanner_performance"].items():
            success_rate = (stats["successful"] / stats["total"] * 100) if stats["total"] > 0 else 0
            print(f"  {scanner}:")
            print(f"    æˆåŠŸç‡: {success_rate:.1f}% ({stats['successful']}/{stats['total']})")
            print(f"    ç™¼ç¾æ•¸: {stats['findings']}")
            print(f"    å¹³å‡æ™‚é–“: {stats['avg_time']:.2f}s")
        
        # é¡¯ç¤ºè©³ç´°çµæœ
        print("\nğŸ“‹ è©³ç´°çµæœ:")
        for result in report["detailed_results"]:
            status = "âœ…" if result["success"] else "âŒ"
            print(f"  {status} {result['scanner']} -> {result['target']}")
            print(f"      ç™¼ç¾: {result['findings_count']}, æ™‚é–“: {result['execution_time']:.2f}s")
            if result["error"]:
                print(f"      éŒ¯èª¤: {result['error']}")
        
        # ä¿å­˜è©³ç´°å ±å‘Š
        report_file = PROJECT_ROOT / "pentest_report.json"
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
        
        print(f"\nğŸ’¾ è©³ç´°å ±å‘Šå·²ä¿å­˜è‡³: {report_file}")
        
        # æœ€çµ‚è©•ä¼°
        if summary["success_rate"] >= 70:
            print("\nğŸ‰ é¶å ´æ¸¬è©¦æˆåŠŸï¼AIVAç³»çµ±é‹è¡Œè‰¯å¥½")
        elif summary["success_rate"] >= 50:
            print("\nâš ï¸ é¶å ´æ¸¬è©¦éƒ¨åˆ†æˆåŠŸï¼Œæœ‰äº›åŠŸèƒ½éœ€è¦æ”¹é€²")
        else:
            print("\nâŒ é¶å ´æ¸¬è©¦ç™¼ç¾å•é¡Œï¼Œéœ€è¦æª¢æŸ¥ç³»çµ±é…ç½®")
        
        return report

async def main():
    """ä¸»å‡½æ•¸"""
    try:
        runner = AIVAPentestRunner()
        await runner.run_pentest()
    except KeyboardInterrupt:
        print("\nâš ï¸ æ¸¬è©¦è¢«ç”¨æˆ¶ä¸­æ–·")
    except Exception as e:
        print(f"\nâŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(main())