#!/bin/bash
# AIVA å°ˆæ¡ˆå®Œæ•´å ±å‘Šç”Ÿæˆå™¨ (Bash ç‰ˆæœ¬)
# æ•´åˆæ¨¹ç‹€åœ–ã€çµ±è¨ˆæ•¸æ“šã€ç¨‹å¼ç¢¼åˆ†æã€å¤šèªè¨€æ”¯æ´

PROJECT_ROOT="${1:-/workspaces/AIVA}"
OUTPUT_DIR="${2:-$PROJECT_ROOT/_out}"

echo "ğŸš€ é–‹å§‹ç”Ÿæˆå°ˆæ¡ˆå®Œæ•´å ±å‘Š..."
echo ""

# è¦æ’é™¤çš„ç›®éŒ„
EXCLUDE_DIRS=(
    ".git"
    "__pycache__"
    ".mypy_cache"
    ".ruff_cache"
    "node_modules"
    ".venv"
    "venv"
    ".pytest_cache"
    ".tox"
    "dist"
    "build"
    ".egg-info"
    ".eggs"
    "htmlcov"
    ".coverage"
    ".hypothesis"
    ".idea"
    ".vscode"
    "target"
    "emoji_backups"
)

# å»ºç«‹ find æ’é™¤åƒæ•¸
FIND_EXCLUDE=""
for dir in "${EXCLUDE_DIRS[@]}"; do
    FIND_EXCLUDE="$FIND_EXCLUDE -path '*/$dir' -prune -o"
done

# å»ºç«‹è¼¸å‡ºç›®éŒ„
mkdir -p "$OUTPUT_DIR"

# ==================== 1. æ”¶é›†çµ±è¨ˆæ•¸æ“š ====================
echo "ğŸ“Š æ”¶é›†å°ˆæ¡ˆçµ±è¨ˆæ•¸æ“š..."
echo ""

# çµ±è¨ˆå„èªè¨€æª”æ¡ˆ
TOTAL_FILES=$(eval "find '$PROJECT_ROOT' $FIND_EXCLUDE -type f -print" | wc -l)
PY_FILES=$(eval "find '$PROJECT_ROOT' $FIND_EXCLUDE -name '*.py' -type f -print" | wc -l)
GO_FILES=$(eval "find '$PROJECT_ROOT' $FIND_EXCLUDE -name '*.go' -type f -print" | wc -l)
RS_FILES=$(eval "find '$PROJECT_ROOT' $FIND_EXCLUDE -name '*.rs' -type f -print" | wc -l)
TS_FILES=$(eval "find '$PROJECT_ROOT' $FIND_EXCLUDE -name '*.ts' -type f -print" | wc -l)
JS_FILES=$(eval "find '$PROJECT_ROOT' $FIND_EXCLUDE -name '*.js' -type f -print" | wc -l)

# çµ±è¨ˆç¨‹å¼ç¢¼è¡Œæ•¸
count_lines() {
    local pattern=$1
    local total=0
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            total=$((total + lines))
        fi
    done < <(eval "find '$PROJECT_ROOT' $FIND_EXCLUDE -name '$pattern' -type f -print")
    echo $total
}

echo "  çµ±è¨ˆ Python ç¨‹å¼ç¢¼..."
PY_LINES=$(count_lines "*.py")
echo "  çµ±è¨ˆ Go ç¨‹å¼ç¢¼..."
GO_LINES=$(count_lines "*.go")
echo "  çµ±è¨ˆ Rust ç¨‹å¼ç¢¼..."
RS_LINES=$(count_lines "*.rs")
echo "  çµ±è¨ˆ TypeScript ç¨‹å¼ç¢¼..."
TS_LINES=$(count_lines "*.ts")
echo "  çµ±è¨ˆ JavaScript ç¨‹å¼ç¢¼..."
JS_LINES=$(count_lines "*.js")

# è¨ˆç®—ç¸½è¨ˆå’Œç™¾åˆ†æ¯”
TOTAL_CODE_LINES=$((PY_LINES + GO_LINES + RS_LINES + TS_LINES + JS_LINES))
if [ $TOTAL_CODE_LINES -eq 0 ]; then
    TOTAL_CODE_LINES=1  # é¿å…é™¤ä»¥é›¶
fi

# è¨ˆç®—ç¸½è¨ˆå’Œç™¾åˆ†æ¯”
TOTAL_CODE_LINES=$((PY_LINES + GO_LINES + RS_LINES + TS_LINES + JS_LINES))
if [ $TOTAL_CODE_LINES -eq 0 ]; then
    TOTAL_CODE_LINES=1  # é¿å…é™¤ä»¥é›¶
fi

PY_PCT=$(awk "BEGIN { printf \"%.1f\", $PY_LINES * 100 / $TOTAL_CODE_LINES }")
GO_PCT=$(awk "BEGIN { printf \"%.1f\", $GO_LINES * 100 / $TOTAL_CODE_LINES }")
RS_PCT=$(awk "BEGIN { printf \"%.1f\", $RS_LINES * 100 / $TOTAL_CODE_LINES }")
TS_JS_PCT=$(awk "BEGIN { printf \"%.1f\", ($TS_LINES + $JS_LINES) * 100 / $TOTAL_CODE_LINES }")

PY_AVG=$(if [ $PY_FILES -gt 0 ]; then awk "BEGIN { printf \"%.1f\", $PY_LINES / $PY_FILES }"; else echo "0"; fi)
GO_AVG=$(if [ $GO_FILES -gt 0 ]; then awk "BEGIN { printf \"%.1f\", $GO_LINES / $GO_FILES }"; else echo "0"; fi)
RS_AVG=$(if [ $RS_FILES -gt 0 ]; then awk "BEGIN { printf \"%.1f\", $RS_LINES / $RS_FILES }"; else echo "0"; fi)

echo "âœ… çµ±è¨ˆå®Œæˆ"
echo ""

# ==================== 2. ç”Ÿæˆæ¨¹ç‹€åœ– ====================
echo "ğŸŒ³ ç”Ÿæˆå°ˆæ¡ˆæ¨¹ç‹€çµæ§‹..."
echo ""

TREE_FILE="$OUTPUT_DIR/tree_ascii.txt"
if command -v tree &> /dev/null; then
    tree -L 3 -I "$(IFS='|'; echo "${EXCLUDE_DIRS[*]}")" "$PROJECT_ROOT" > "$TREE_FILE"
    echo "âœ… æ¨¹ç‹€åœ–å·²ç”Ÿæˆ: tree_ascii.txt"
else
    echo "âš ï¸  tree å‘½ä»¤ä¸å­˜åœ¨ï¼Œè·³éæ¨¹ç‹€åœ–ç”Ÿæˆ"
    echo "å°ˆæ¡ˆæ ¹ç›®éŒ„: $PROJECT_ROOT" > "$TREE_FILE"
fi
echo ""

# ==================== 3. ç”Ÿæˆæ•´åˆå ±å‘Š ====================
echo "ğŸ“ ç”Ÿæˆæ•´åˆå ±å‘Š..."
echo ""

REPORT_FILE="$OUTPUT_DIR/PROJECT_REPORT.txt"
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

cat > "$REPORT_FILE" << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         AIVA å°ˆæ¡ˆå®Œæ•´åˆ†æå ±å‘Š                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”Ÿæˆæ™‚é–“: $TIMESTAMP
å°ˆæ¡ˆè·¯å¾‘: $PROJECT_ROOT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š å°ˆæ¡ˆçµ±è¨ˆæ‘˜è¦
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç¸½æ–‡ä»¶æ•¸é‡: $TOTAL_FILES
ç¸½ç¨‹å¼ç¢¼è¡Œæ•¸: $TOTAL_CODE_LINES
ç¨‹å¼ç¢¼æª”æ¡ˆæ•¸: $((PY_FILES + GO_FILES + RS_FILES + TS_FILES + JS_FILES))

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’» å¤šèªè¨€ç¨‹å¼ç¢¼çµ±è¨ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ Python
   æª”æ¡ˆæ•¸: $PY_FILES å€‹
   ç¨‹å¼ç¢¼è¡Œæ•¸: $PY_LINES è¡Œ
   å¹³å‡æ¯å€‹æª”æ¡ˆ: $PY_AVG è¡Œ
   ä½”æ¯”: $PY_PCT%

ğŸ”· Go
   æª”æ¡ˆæ•¸: $GO_FILES å€‹
   ç¨‹å¼ç¢¼è¡Œæ•¸: $GO_LINES è¡Œ
   å¹³å‡æ¯å€‹æª”æ¡ˆ: $GO_AVG è¡Œ
   ä½”æ¯”: $GO_PCT%

ğŸ¦€ Rust
   æª”æ¡ˆæ•¸: $RS_FILES å€‹
   ç¨‹å¼ç¢¼è¡Œæ•¸: $RS_LINES è¡Œ
   å¹³å‡æ¯å€‹æª”æ¡ˆ: $RS_AVG è¡Œ
   ä½”æ¯”: $RS_PCT%

ğŸ“˜ TypeScript/JavaScript
   æª”æ¡ˆæ•¸: $((TS_FILES + JS_FILES)) å€‹
   ç¨‹å¼ç¢¼è¡Œæ•¸: $((TS_LINES + JS_LINES)) è¡Œ
   ä½”æ¯”: $TS_JS_PCT%

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ˆ å°ˆæ¡ˆè¦æ¨¡åˆ†æ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

èªè¨€åˆ†å¸ƒ:
  Python:     $PY_PCT% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  Go:         $GO_PCT%
  Rust:       $RS_PCT%
  TS/JS:      $TS_JS_PCT%

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸš« å·²æ’é™¤çš„ç›®éŒ„é¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

EOF

for dir in "${EXCLUDE_DIRS[@]}"; do
    echo "  â€¢ $dir" >> "$REPORT_FILE"
done

cat >> "$REPORT_FILE" << EOF

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸŒ³ å°ˆæ¡ˆç›®éŒ„çµæ§‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è©³ç´°æ¨¹ç‹€çµæ§‹è«‹åƒè€ƒ: tree_ascii.txt

åŸºæœ¬çµæ§‹:
  services/
    â”œâ”€â”€ aiva_common/     å…±ç”¨æ¨¡çµ„
    â”œâ”€â”€ core/            æ ¸å¿ƒå¼•æ“
    â”œâ”€â”€ function/        åŠŸèƒ½æ¨¡çµ„ (Python, Go, Rust)
    â”œâ”€â”€ integration/     æ•´åˆå±¤
    â””â”€â”€ scan/            æƒæå¼•æ“ (Python, TypeScript)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ å°ˆæ¡ˆæ¶æ§‹èªªæ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å¤šèªè¨€æ¶æ§‹è¨­è¨ˆ:
  â€¢ Python: ä¸»è¦æ¥­å‹™é‚è¼¯ã€Web APIã€æ ¸å¿ƒå¼•æ“
  â€¢ Go: é«˜æ•ˆèƒ½æ¨¡çµ„ (èº«ä»½é©—è­‰ã€é›²ç«¯å®‰å…¨ã€çµ„æˆåˆ†æ)
  â€¢ Rust: éœæ…‹åˆ†æã€è³‡è¨Šæ”¶é›† (è¨˜æ†¶é«”å®‰å…¨ã€é«˜æ•ˆèƒ½)
  â€¢ TypeScript: å‹•æ…‹æƒæå¼•æ“ (Playwright ç€è¦½å™¨è‡ªå‹•åŒ–)

æŠ€è¡“æ£§è©³ç´°è³‡è¨Š:
  â€¢ è©³ç´°æ¶æ§‹åœ–è«‹åƒè€ƒ: ARCHITECTURE_DIAGRAMS.md
  â€¢ ç¨‹å¼ç¢¼åˆ†æè«‹åƒè€ƒ: _out/analysis/ ç›®éŒ„

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Œ å ±å‘Šèªªæ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ æœ¬å ±å‘Šæ•´åˆäº†å°ˆæ¡ˆçš„æª”æ¡ˆçµ±è¨ˆã€ç¨‹å¼ç¢¼è¡Œæ•¸åˆ†æå’Œç›®éŒ„çµæ§‹
â€¢ å·²è‡ªå‹•æ’é™¤è™›æ“¬ç’°å¢ƒã€å¿«å–æª”æ¡ˆã€IDE é…ç½®ç­‰éç¨‹å¼ç¢¼ç›®éŒ„
â€¢ åœ–ç¤ºèªªæ˜:
  ğŸ Python   ğŸ“œ JavaScript   ğŸ“˜ TypeScript   ğŸ“ Markdown
  âš™ï¸ JSON      ğŸ”§ YAML         ğŸ—„ï¸ SQL          âš¡ Shell/Batch
  ğŸ”· Go        ğŸ¦€ Rust         ğŸŒ HTML         ğŸ¨ CSS
  ğŸ“ ç›®éŒ„      ğŸ“„ å…¶ä»–æª”æ¡ˆ

â€¢ å¤šèªè¨€æ¶æ§‹:
  - Python: ä¸»è¦æ¥­å‹™é‚è¼¯ã€Web APIã€æ ¸å¿ƒå¼•æ“
  - Go: é«˜æ•ˆèƒ½æ¨¡çµ„ (èº«ä»½é©—è­‰ã€é›²ç«¯å®‰å…¨ã€çµ„æˆåˆ†æ)
  - Rust: éœæ…‹åˆ†æã€è³‡è¨Šæ”¶é›† (è¨˜æ†¶é«”å®‰å…¨ã€é«˜æ•ˆèƒ½)
  - TypeScript: å‹•æ…‹æƒæå¼•æ“ (Playwright ç€è¦½å™¨è‡ªå‹•åŒ–)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ¨ å ±å‘ŠçµæŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

echo "âœ… å ±å‘Šå·²ç”Ÿæˆ: PROJECT_REPORT.txt"
echo ""

# ==================== 4. ç”Ÿæˆ Mermaid åœ–è¡¨ ====================
echo "ğŸ“Š ç”Ÿæˆ Mermaid æ¶æ§‹åœ–..."
echo ""

python3 "$PROJECT_ROOT/tools/generate_mermaid_diagrams.py"

echo ""

# ==================== 5. å®Œæˆ ====================
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          âœ¨ å ±å‘Šç”Ÿæˆå®Œæˆï¼                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“„ å ±å‘Šä½ç½®: $REPORT_FILE"
echo "ğŸ“Š çµ±è¨ˆè³‡æ–™: å·²æ•´åˆ"
echo "ğŸŒ³ ç›®éŒ„çµæ§‹: å·²æ•´åˆ"
echo "ğŸ“ˆ Mermaid åœ–è¡¨: $OUTPUT_DIR/ARCHITECTURE_DIAGRAMS.md"
echo ""
echo "ç”Ÿæˆçš„æª”æ¡ˆ:"
echo "  â€¢ PROJECT_REPORT.txt         - å®Œæ•´å°ˆæ¡ˆå ±å‘Š"
echo "  â€¢ ARCHITECTURE_DIAGRAMS.md   - Mermaid æ¶æ§‹åœ–é›†"
echo "  â€¢ tree_ascii.txt             - ç›®éŒ„æ¨¹ç‹€çµæ§‹"
echo "  â€¢ analysis/                  - ç¨‹å¼ç¢¼åˆ†æå ±å‘Š"
echo ""
