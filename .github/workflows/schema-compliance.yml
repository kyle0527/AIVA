name: Schema Compliance Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'schemas/**'
      - 'tools/schema_compliance_validator.py'
      - 'tools/ci_schema_check.py'

jobs:
  schema-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install toml
    
    - name: Run Schema Compliance Check
      id: schema_check
      run: |
        cd ${{ github.workspace }}
        python tools/ci_schema_check.py --pr-comment
      continue-on-error: true
    
    - name: Upload Compliance Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: schema-compliance-report
        path: |
          schema_compliance_result.properties
          *.json
        retention-days: 30
    
    - name: Comment on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          // è®€å–æª¢æŸ¥çµæœ
          let commentBody = '## ğŸ” Schema åˆè¦æ€§æª¢æŸ¥çµæœ\n\n';
          
          try {
            // æª¢æŸ¥æ˜¯å¦æœ‰åˆè¦æ€§å ±å‘Šæ–‡ä»¶
            if (fs.existsSync('schema_compliance_result.properties')) {
              const props = fs.readFileSync('schema_compliance_result.properties', 'utf8');
              const lines = props.split('\n');
              
              let success = false;
              let score = 0;
              
              for (const line of lines) {
                if (line.startsWith('SCHEMA_COMPLIANCE_SUCCESS=')) {
                  success = line.split('=')[1] === 'true';
                }
                if (line.startsWith('SCHEMA_COMPLIANCE_SCORE=')) {
                  score = parseFloat(line.split('=')[1]);
                }
              }
              
              if (success) {
                commentBody += `âœ… **æª¢æŸ¥é€šé** - å¹³å‡åˆ†æ•¸: ${score.toFixed(1)}/100\n\n`;
                commentBody += 'æ‰€æœ‰æ¨¡çµ„å‡ç¬¦åˆ Schema æ¨™æº–åŒ–è¦æ±‚ã€‚\n\n';
              } else {
                commentBody += `âŒ **æª¢æŸ¥å¤±æ•—** - å¹³å‡åˆ†æ•¸: ${score.toFixed(1)}/100\n\n`;
                commentBody += 'ç™¼ç¾æ¨¡çµ„æœªéµå¾ªæ¨™æº– Schemaï¼Œè«‹æŸ¥çœ‹è©³ç´°å ±å‘Šé€²è¡Œä¿®å¾©ã€‚\n\n';
              }
              
              commentBody += '### ğŸ“‹ æª¢æŸ¥ç¯„åœ\n';
              commentBody += '- Go æ¨¡çµ„ï¼šæª¢æŸ¥æ˜¯å¦ä½¿ç”¨ `aiva_common_go/schemas/generated`\n';
              commentBody += '- Rust æ¨¡çµ„ï¼šæª¢æŸ¥æ˜¯å¦å¯¦ç¾æ¨™æº– schema çµæ§‹\n';
              commentBody += '- TypeScript æ¨¡çµ„ï¼šæª¢æŸ¥æ˜¯å¦ä½¿ç”¨ `schemas/aiva_schemas`\n\n';
              
              commentBody += '### ğŸ’¡ ä¿®å¾©å»ºè­°\n';
              commentBody += '1. ç§»é™¤æ‰€æœ‰è‡ªå®šç¾© `FindingPayload` å®šç¾©\n';
              commentBody += '2. ä½¿ç”¨å°æ‡‰èªè¨€çš„æ¨™æº– schema å°å…¥\n';
              commentBody += '3. ç¢ºä¿æ‰€æœ‰å­—æ®µåç¨±ç¬¦åˆæ¨™æº–æ ¼å¼\n\n';
              
              if (!success) {
                commentBody += '> âš ï¸ æ­¤ PR åŒ…å« Schema åˆè¦æ€§å•é¡Œï¼Œå»ºè­°åœ¨åˆä½µå‰ä¿®å¾©ã€‚\n';
              }
              
            } else {
              commentBody += 'âš ï¸ ç„¡æ³•è®€å–æª¢æŸ¥çµæœï¼Œè«‹æª¢æŸ¥å·¥ä½œæµé…ç½®ã€‚\n';
            }
          } catch (error) {
            commentBody += `âŒ è™•ç†æª¢æŸ¥çµæœæ™‚å‡ºéŒ¯: ${error.message}\n`;
          }
          
          commentBody += '\n---\n*ç”± AIVA Schema åˆè¦æ€§æª¢æŸ¥å™¨è‡ªå‹•ç”Ÿæˆ*';
          
          // æŸ¥æ‰¾ç¾æœ‰è©•è«–
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          const existingComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Schema åˆè¦æ€§æª¢æŸ¥çµæœ')
          );
          
          if (existingComment) {
            // æ›´æ–°ç¾æœ‰è©•è«–
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: commentBody
            });
          } else {
            // å‰µå»ºæ–°è©•è«–
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }
    
    - name: Fail on non-compliance
      if: steps.schema_check.outcome == 'failure'
      run: |
        echo "Schema compliance check failed. Please fix the issues before merging."
        exit 1